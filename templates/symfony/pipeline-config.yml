# Unified CI/CD Configuration for Symfony Projects
# Schema: https://raw.githubusercontent.com/meteor-digital/github-actions/main/schemas/pipeline-config.schema.json

project:
  name: "my-symfony-app"  # Used for artifacts, notifications, and releases
  # type: "symfony"  # Auto-detected from symfony.lock file
  
runtime:
  php_version: "8.1"  # PHP version for builds and quality checks
  node_version: "18"  # Node.js version for asset compilation
  php_extensions: "mbstring, intl, gd, xml, zip, curl, opcache, redis, mysql"
  
build:
  # Files and directories to exclude from build artifacts
  exclude_patterns: |
    *.git*
    node_modules/*
    tests/*
    .env*
    .env.local*
    .env.test*
    var/cache/*
    var/log/*
    public/bundles/*
    *.log
    *.cache
    .phpunit.result.cache
    .php-cs-fixer.cache
  
  # Commands to run during build process
  build_commands:
    - "npm run build"
    - "composer install --no-dev --optimize-autoloader"
    - "bin/console cache:warmup --env=prod"
    - "bin/console assets:install --env=prod"
  
artifacts:
  retention_days: 7  # Keep artifacts for 7 days

notifications:
  notification_webhook: "https://cronos.webhook.office.com/webhookb2/KEY1/IncomingWebhook/KEY2"

deployment:
  environments:
    test:
      host: "test.example.com"  # Replace with actual hostname
      path: "/var/www/test"  # Replace with actual path
      maintenance_mode: true
      
    staging:
      host: "staging.example.com"  # Replace with actual hostname
      path: "/var/www/staging"  # Replace with actual path
      maintenance_mode: true
      
    prod:
      host: "prod.example.com"  # Replace with actual hostname
      path: "/var/www/prod"  # Replace with actual path
      maintenance_mode: true

  hosting:
    provider: "{{HOSTING_PROVIDER}}"  # level27, byte, hipex, hostedpower, generic
    ssh_port: 22
    php_service: "php8.1-fpm"
    messenger_worker_id: "1"  # For Symfony messenger workers (Level27 specific)

  # Optional: Override framework defaults
  # Symfony defaults include:
  # - shared_folders: ["var", "public/uploads"]
  # - post_deploy: ["bin/console cache:warmup --env=prod"]
  
  # Add custom shared folders to framework defaults
  shared_folders:
    - "public/media"  # Custom media directory
  
  commands:
    pre_deploy:
      - "bin/console doctrine:migrations:migrate --no-interaction"  # Run database migrations
      - "bin/console messenger:setup-transports"  # Setup message queues
    post_deploy:
      - "bin/console cache:pool:clear cache.global_clearer"  # Clear specific cache pools
      - "bin/console assets:install --symlink --relative"    # Install assets
  
  cleanup:
    keep_releases: 3  # Keep 3 releases for rollback capability