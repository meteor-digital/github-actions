{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/meteor-digital/github-actions/main/schemas/pipeline-config.schema.json",
  "title": "Pipeline Configuration Schema",
  "description": "Schema for unified CI/CD pipeline configuration file (pipeline-config.yml) used by generic CI/CD workflows",
  "type": "object",
  "required": ["project", "runtime"],
  "properties": {
    "project": {
      "type": "object",
      "description": "Project-specific configuration",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Project name used for artifacts, notifications, and releases. Defaults to repository name if not specified.",
          "pattern": "^[a-zA-Z0-9][a-zA-Z0-9-_]*[a-zA-Z0-9]$",
          "minLength": 2,
          "maxLength": 50,
          "examples": ["my-shopware-shop", "laravel-api", "symfony-webapp"]
        },
        "type": {
          "type": "string",
          "description": "Project type (auto-detected if not specified). Detection order: .shopware-project.yml → artisan → symfony.lock → default shopware",
          "enum": ["shopware", "laravel", "symfony", "generic"],
          "default": "shopware"
        }
      },
      "additionalProperties": false
    },
    "runtime": {
      "type": "object",
      "description": "Runtime environment configuration",
      "required": ["php_version"],
      "properties": {
        "php_version": {
          "type": "string",
          "description": "PHP version to use for builds and quality checks",
          "pattern": "^[0-9]+\\.[0-9]+$",
          "examples": ["8.1", "8.2", "8.3"]
        },
        "node_version": {
          "type": "string",
          "description": "Node.js version to use for asset compilation",
          "pattern": "^[0-9]+$",
          "default": "18",
          "examples": ["16", "18", "20"]
        },
        "php_extensions": {
          "type": "string",
          "description": "Comma-separated list of PHP extensions to install",
          "default": "mbstring, intl, gd, xml, zip, curl, opcache",
          "examples": [
            "mbstring, intl, gd, xml, zip, curl, opcache",
            "mbstring, intl, gd, xml, zip, curl, opcache, redis, mysql"
          ]
        }
      },
      "additionalProperties": false
    },
    "build": {
      "type": "object",
      "description": "Build configuration",
      "properties": {
        "exclude_patterns": {
          "type": "string",
          "description": "Multi-line string with glob patterns for files to exclude from build artifacts",
          "default": "*.git*\nnode_modules/*\ntests/*\n.env*",
          "examples": [
            "*.git*\nnode_modules/*\ntests/*\n.env*\nvar/cache/*\nvar/log/*",
            "*.git*\nnode_modules/*\ntests/*\n.env*\nstorage/logs/*\nstorage/framework/cache/*"
          ]
        },
        "build_commands": {
          "type": "array",
          "description": "Array of shell commands to execute during build process",
          "items": {
            "type": "string"
          },
          "default": ["npm run build", "composer install --no-dev --optimize-autoloader"],
          "examples": [
            ["npm run build", "composer install --no-dev --optimize-autoloader"],
            ["npm run build", "composer install --no-dev", "php artisan config:cache", "php artisan route:cache"],
            ["npm run build", "composer install --no-dev", "bin/console cache:warmup --env=prod"]
          ]
        },
        "artifacts": {
          "type": "object",
          "description": "Build artifact configuration",
          "properties": {
            "retention_days": {
              "type": "integer",
              "description": "Number of days to retain build artifacts",
              "minimum": 1,
              "maximum": 90,
              "default": 7
            },
            "naming_pattern": {
              "type": "string",
              "description": "Pattern for artifact naming. Available variables: {environment}, {version}, {project}",
              "default": "{environment}-build-{version}",
              "examples": [
                "{environment}-build-{version}",
                "{project}-{environment}-{version}",
                "build-{project}-{environment}-{version}"
              ]
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "quality_checks": {
      "type": "object",
      "description": "Quality checks and code validation configuration",
      "properties": {
        "enabled_tools": {
          "type": "array",
          "description": "List of quality tools to enable",
          "items": {
            "type": "string",
            "enum": ["php-cs-fixer", "psalm", "phpstan", "rector", "phpunit", "composer-validate", "phpunuhi"]
          },
          "default": ["php-cs-fixer", "psalm", "phpstan", "rector", "phpunit", "composer-validate"],
          "examples": [
            ["php-cs-fixer", "phpstan", "rector", "phpunit"],
            ["php-cs-fixer", "psalm", "rector", "phpunit", "composer-validate", "phpunuhi"]
          ]
        },
        "tool_binaries": {
          "type": "object",
          "description": "Override default binary paths for quality tools",
          "properties": {
            "php-cs-fixer": {
              "type": "string",
              "description": "Path to php-cs-fixer binary",
              "default": "./vendor/bin/php-cs-fixer",
              "examples": ["./bin/php-cs-fixer", "./vendor/meteor/shop6-project-conventions/tools/php-cs-fixer"]
            },
            "psalm": {
              "type": "string",
              "description": "Path to psalm binary",
              "default": "./vendor/bin/psalm"
            },
            "phpstan": {
              "type": "string",
              "description": "Path to phpstan binary",
              "default": "./vendor/bin/phpstan"
            },
            "rector": {
              "type": "string",
              "description": "Path to rector binary",
              "default": "./vendor/bin/rector"
            },
            "phpunit": {
              "type": "string",
              "description": "Path to phpunit binary",
              "default": "./vendor/bin/phpunit"
            },
            "phpunuhi": {
              "type": "string",
              "description": "Path to phpunuhi binary",
              "default": "./vendor/bin/phpunuhi"
            }
          },
          "additionalProperties": false
        },
        "test_environment": {
          "type": "object",
          "description": "Test environment configuration for quality checks",
          "properties": {
            "env_vars": {
              "type": "array",
              "description": "Additional environment variables for testing",
              "items": {
                "type": "string"
              },
              "examples": [
                ["CUSTOM_API_KEY=\"${secrets.CUSTOM_API_KEY}\""],
                ["TEST_DATABASE_URL=\"sqlite:///:memory:\""]
              ]
            }
          },
          "additionalProperties": false
        },
        "custom_checks": {
          "type": "array",
          "description": "Custom quality checks specific to your project",
          "items": {
            "type": "object",
            "required": ["name", "command"],
            "properties": {
              "name": {
                "type": "string",
                "description": "Name of the custom check"
              },
              "command": {
                "type": "string",
                "description": "Shell command to execute for the check"
              }
            },
            "additionalProperties": false
          },
          "examples": [
            [
              {
                "name": "phpunuhi",
                "command": "php ./vendor/bin/phpunuhi validate:all"
              },
              {
                "name": "security-audit",
                "command": "composer audit"
              }
            ]
          ]
        }
      },
      "additionalProperties": false
    },
    "notifications": {
      "type": "object",
      "description": "Notification configuration",
      "properties": {
        "notification_webhook": {
          "type": "string",
          "description": "Webhook URL for notifications (Teams, Slack, etc.)",
          "format": "uri",
          "examples": [
            "https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX",
            "https://cronos.webhook.office.com/webhookb2/KEY1/IncomingWebhook/KEY2"
          ]
        }
      },
      "additionalProperties": false
    },
    "deployment": {
      "type": "object",
      "description": "Deployment configuration",
      "properties": {
        "environments": {
          "type": "object",
          "description": "Environment-specific deployment configuration",
          "patternProperties": {
            "^[a-zA-Z][a-zA-Z0-9-_]*$": {
              "$ref": "#/definitions/environment"
            }
          },
          "additionalProperties": false,
          "minProperties": 1
        },
        "hosting": {
          "type": "object",
          "description": "Hosting provider configuration",
          "required": ["provider"],
          "properties": {
            "provider": {
              "type": "string",
              "description": "Hosting provider type",
              "enum": ["level27", "byte", "hipex", "hostedpower", "generic"]
            },
            "php_service": {
              "type": "string",
              "description": "PHP service name for restart commands",
              "default": "php-fpm",
              "examples": ["php8.1-fpm", "php-fpm", "php81-fpm"]
            },
            "messenger_worker_id": {
              "type": "string",
              "description": "Messenger worker ID for Shopware/Symfony projects (Level27 specific)",
              "examples": ["1", "worker-1"]
            },
            "custom_commands": {
              "type": "object",
              "description": "Custom commands for generic hosting provider",
              "properties": {
                "restart_services": {
                  "type": "string",
                  "description": "Command to restart web services",
                  "examples": ["sudo service nginx reload && sudo service php-fpm restart"]
                },
                "restart_php": {
                  "type": "string",
                  "description": "Command to restart PHP service",
                  "examples": ["sudo service php-fpm restart"]
                },
                "restart_webserver": {
                  "type": "string",
                  "description": "Command to restart web server",
                  "examples": ["sudo service nginx reload"]
                }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        },
        "shared_folders": {
          "type": "array",
          "description": "Folders to be shared between releases (framework-specific defaults are automatically included)",
          "items": {
            "type": "string"
          },
          "examples": [
            ["files", "public/media", "config/jwt", "var/log"],
            ["storage", "bootstrap/cache"],
            ["var", "public/uploads"]
          ]
        },
        "commands": {
          "type": "object",
          "description": "Custom deployment commands (framework-specific defaults are automatically included)",
          "properties": {
            "pre_deploy": {
              "type": "array",
              "description": "Commands to run before atomic deployment switch",
              "items": {
                "type": "string"
              },
              "examples": [
                ["bin/console database:migrate --all"],
                ["php artisan migrate --force"],
                ["bin/console doctrine:migrations:migrate --no-interaction"]
              ]
            },
            "post_deploy": {
              "type": "array",
              "description": "Commands to run after atomic deployment switch",
              "items": {
                "type": "string"
              },
              "examples": [
                ["bin/console theme:dump --no-interaction", "bin/console theme:compile --active-only", "bin/console asset:install"],
                ["php artisan config:cache", "php artisan route:cache"],
                ["bin/console cache:warmup --env=prod"]
              ]
            }
          },
          "additionalProperties": false
        },
        "cleanup": {
          "type": "object",
          "description": "Release cleanup configuration",
          "properties": {
            "keep_releases": {
              "type": "integer",
              "description": "Number of releases to keep for rollback capability",
              "minimum": 1,
              "maximum": 10,
              "default": 3
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  },
  "definitions": {
    "environment": {
      "type": "object",
      "description": "Single environment configuration",
      "required": ["host", "path", "ssh_user"],
      "properties": {
        "host": {
          "type": "string",
          "description": "Hostname or IP address for deployment",
          "examples": ["prod.example.com", "192.168.1.100"]
        },
        "path": {
          "type": "string",
          "description": "Deployment path on the target host",
          "examples": ["/var/www/prod", "/home/user/app"]
        },
        "maintenance_mode": {
          "type": "boolean",
          "description": "Whether to enable maintenance mode during deployment",
          "default": true
        },
        "messenger_worker_id": {
          "type": "string",
          "description": "Environment-specific messenger worker ID (overrides global setting)",
          "examples": ["1", "worker-1"]
        },
        "provider": {
          "type": "string",
          "description": "Hosting provider type (flat override)",
          "enum": ["level27", "byte", "hipex", "hostedpower", "generic"]
        },
        "php_service": {
          "type": "string",
          "description": "PHP service name for restart commands (flat override)",
          "examples": ["php8.1-fpm", "php-fpm", "php81-fpm"]
        },
        "database_url": {
          "type": "string",
          "description": "Database connection URL (optional, can use environment variables)",
          "examples": ["${DATABASE_URL}", "mysql://user:pass@host:3306/db"]
        },
        "ssh_user": {
          "type": "string",
          "description": "SSH username for deployment connection",
          "examples": ["deploy", "www-data", "vd22790"]
        },
        "ssh_port": {
          "type": "integer",
          "description": "SSH port for deployment connection",
          "minimum": 1,
          "maximum": 65535,
          "default": 22,
          "examples": [22, 2222]
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}