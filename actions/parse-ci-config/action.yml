name: 'Parse CI Configuration'
description: 'Parses CI configuration from YAML file'

inputs:
  config_file:
    description: 'Path to CI configuration file'
    required: false
    default: '.github/ci-config.yml'

outputs:
  project_name:
    description: 'Project name from configuration'
    value: ${{ steps.parse.outputs.project_name }}
  php_version:
    description: 'PHP version from configuration'
    value: ${{ steps.parse.outputs.php_version }}
  node_version:
    description: 'Node.js version from configuration'
    value: ${{ steps.parse.outputs.node_version }}
  php_extensions:
    description: 'PHP extensions from configuration'
    value: ${{ steps.parse.outputs.php_extensions }}
  build_commands:
    description: 'Build commands from configuration'
    value: ${{ steps.parse.outputs.build_commands }}
  exclude_patterns:
    description: 'File exclusion patterns from configuration'
    value: ${{ steps.parse.outputs.exclude_patterns }}
  retention_days:
    description: 'Artifact retention days from configuration'
    value: ${{ steps.parse.outputs.retention_days }}

runs:
  using: 'composite'
  steps:
    - name: Parse configuration
      id: parse
      shell: bash
      run: |
        CONFIG_FILE="${{ inputs.config_file }}"
        
        echo "ðŸ“‹ Reading configuration from: $CONFIG_FILE"
        
        # Initialize default values
        PROJECT_NAME="${{ github.event.repository.name }}"
        PHP_VERSION=""
        NODE_VERSION="18"
        PHP_EXTENSIONS="mbstring, intl, gd, xml, zip, curl, opcache"
        BUILD_COMMANDS="npm run build
        composer install --no-dev --optimize-autoloader"
        RETENTION_DAYS="7"
        EXCLUDE_PATTERNS="*.git*
        node_modules/*
        tests/*
        .env*
        *.log
        *.cache"
        
        if [ -f "$CONFIG_FILE" ]; then
          echo "âœ… Configuration file found, parsing..."
          
          # Validate YAML syntax first
          if command -v yq >/dev/null 2>&1; then
            if ! yq eval '.' "$CONFIG_FILE" > /dev/null 2>&1; then
              echo "âŒ Error: Invalid YAML syntax in $CONFIG_FILE"
              exit 1
            fi
          fi
          
          # Parse using yq if available, otherwise use grep/sed
          if command -v yq >/dev/null 2>&1; then
            echo "ðŸ“¦ Using yq for YAML parsing"
            PARSED_PROJECT_NAME=$(yq eval '.project.name' "$CONFIG_FILE" 2>/dev/null)
            PARSED_PHP_VERSION=$(yq eval '.runtime.php_version' "$CONFIG_FILE" 2>/dev/null)
            PARSED_NODE_VERSION=$(yq eval '.runtime.node_version' "$CONFIG_FILE" 2>/dev/null)
            PARSED_PHP_EXTENSIONS=$(yq eval '.runtime.php_extensions' "$CONFIG_FILE" 2>/dev/null)
            PARSED_RETENTION_DAYS=$(yq eval '.artifacts.retention_days' "$CONFIG_FILE" 2>/dev/null)
          else
            echo "ðŸ“ Using grep/sed for YAML parsing"
            # Parse project name
            if grep -q "project:" "$CONFIG_FILE"; then
              PARSED_PROJECT_NAME=$(grep -A 5 "project:" "$CONFIG_FILE" | grep "name:" | sed 's/.*name:[[:space:]]*["\x27]\?\([^"\x27]*\)["\x27]\?.*/\1/' | head -1)
            fi
            
            # Parse runtime settings
            PARSED_PHP_VERSION=$(grep -A 20 "^runtime:" "$CONFIG_FILE" | grep "^\s*php_version:" | sed 's/.*php_version:\s*["\x27]\?\([^"\x27]*\)["\x27]\?.*/\1/' | head -1)
            PARSED_NODE_VERSION=$(grep -A 20 "^runtime:" "$CONFIG_FILE" | grep "^\s*node_version:" | sed 's/.*node_version:\s*["\x27]\?\([^"\x27]*\)["\x27]\?.*/\1/' | head -1)
            PARSED_PHP_EXTENSIONS=$(grep -A 20 "^runtime:" "$CONFIG_FILE" | grep "^\s*php_extensions:" | sed 's/.*php_extensions:\s*["\x27]\?\([^"\x27]*\)["\x27]\?.*/\1/' | head -1)
            PARSED_RETENTION_DAYS=$(grep -A 20 "^artifacts:" "$CONFIG_FILE" | grep "^\s*retention_days:" | sed 's/.*retention_days:\s*["\x27]\?\([^"\x27]*\)["\x27]\?.*/\1/' | head -1)
          fi
          
          # Use parsed values if available, otherwise keep defaults
          if [ -n "$PARSED_PROJECT_NAME" ] && [ "$PARSED_PROJECT_NAME" != "null" ]; then
            PROJECT_NAME="$PARSED_PROJECT_NAME"
          fi
          
          if [ -n "$PARSED_PHP_VERSION" ] && [ "$PARSED_PHP_VERSION" != "null" ]; then
            PHP_VERSION="$PARSED_PHP_VERSION"
            # Validate PHP version format
            if ! [[ "$PHP_VERSION" =~ ^[0-9]+\.[0-9]+$ ]]; then
              echo "âŒ Error: Invalid PHP version format '$PHP_VERSION' (expected: X.Y)"
              exit 1
            fi
          else
            echo "âŒ Error: PHP version is required in runtime.php_version"
            exit 1
          fi
          
          if [ -n "$PARSED_NODE_VERSION" ] && [ "$PARSED_NODE_VERSION" != "null" ]; then
            NODE_VERSION="$PARSED_NODE_VERSION"
            # Validate Node version format
            if ! [[ "$NODE_VERSION" =~ ^[0-9]+$ ]]; then
              echo "âŒ Error: Invalid Node.js version format '$NODE_VERSION' (expected: integer)"
              exit 1
            fi
          fi
          
          if [ -n "$PARSED_PHP_EXTENSIONS" ] && [ "$PARSED_PHP_EXTENSIONS" != "null" ]; then
            PHP_EXTENSIONS="$PARSED_PHP_EXTENSIONS"
          fi
          
          if [ -n "$PARSED_RETENTION_DAYS" ] && [ "$PARSED_RETENTION_DAYS" != "null" ]; then
            RETENTION_DAYS="$PARSED_RETENTION_DAYS"
            # Validate retention days is a number
            if ! [[ "$RETENTION_DAYS" =~ ^[0-9]+$ ]]; then
              echo "âŒ Error: Invalid retention_days format '$RETENTION_DAYS' (expected: integer)"
              exit 1
            fi
          fi
          
          # Parse build commands
          if grep -q "build_commands:" "$CONFIG_FILE"; then
            BUILD_COMMANDS=$(awk '
              /build_commands:/ { in_build_commands = 1; next }
              in_build_commands && /^[[:space:]]*[^[:space:]-]/ && !/^[[:space:]]*-/ { in_build_commands = 0 }
              in_build_commands && /^[[:space:]]*-/ {
                gsub(/^[[:space:]]*-[[:space:]]*["\x27]?/, "")
                gsub(/["\x27][[:space:]]*$/, "")
                if (length($0) > 0) print $0
              }
            ' "$CONFIG_FILE")
          fi
          
          # Parse exclude patterns
          if grep -q "exclude_patterns:" "$CONFIG_FILE"; then
            CUSTOM_EXCLUDES=$(awk '/exclude_patterns:/,/^[[:space:]]*[^[:space:]]/ {
              if (NR > 1 && $0 !~ /exclude_patterns:/ && $0 ~ /^[[:space:]]+[^[:space:]]/) {
                gsub(/^[[:space:]]+/, "")
                if (length($0) > 0) print $0
              }
            }' "$CONFIG_FILE")
            if [ -n "$CUSTOM_EXCLUDES" ]; then
              EXCLUDE_PATTERNS="$CUSTOM_EXCLUDES"
            fi
          fi
        else
          echo "âš ï¸  Configuration file not found: $CONFIG_FILE"
          echo "ðŸ’¡ Using default values"
        fi
        
        echo "ðŸ“Š Configuration summary:"
        echo "  Project name: $PROJECT_NAME"
        echo "  PHP version: $PHP_VERSION"
        echo "  Node version: $NODE_VERSION"
        echo "  PHP extensions: $PHP_EXTENSIONS"
        echo "  Retention days: $RETENTION_DAYS"
        echo "  Build commands: $(echo "$BUILD_COMMANDS" | wc -l) commands"
        echo "  Exclude patterns: $(echo "$EXCLUDE_PATTERNS" | wc -l) patterns"
        
        # Set outputs
        echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
        echo "php_version=$PHP_VERSION" >> $GITHUB_OUTPUT
        echo "node_version=$NODE_VERSION" >> $GITHUB_OUTPUT
        echo "php_extensions=$PHP_EXTENSIONS" >> $GITHUB_OUTPUT
        echo "retention_days=$RETENTION_DAYS" >> $GITHUB_OUTPUT
        echo "build_commands<<EOF" >> $GITHUB_OUTPUT
        echo "$BUILD_COMMANDS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "exclude_patterns<<EOF" >> $GITHUB_OUTPUT
        echo "$EXCLUDE_PATTERNS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT