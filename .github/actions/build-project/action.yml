name: 'Build Project'
description: 'Builds the project using framework-specific commands and configurations'

inputs:
  config_file:
    description: 'Path to CI configuration file'
    required: false
    default: '.github/pipeline-config.yml'

runs:
  using: 'composite'
  steps:
    - name: 'ğŸ” Detect project type'
      id: project-type
      uses: meteor-digital/github-actions/.github/actions/detect-project-type@main

    - name: 'ğŸ“‹ Read build configuration'
      id: config
      uses: meteor-digital/github-actions/.github/actions/parse-pipeline-config@main
      with:
        config_file: ${{ inputs.config_file }}
        
    - name: 'ğŸ›ï¸ Install Shopware CLI'
      if: steps.project-type.outputs.type == 'shopware'
      uses: shopware/shopware-cli-action@v2
    
    - name: 'ğŸ›ï¸ Prepare Shopware environment'
      if: steps.project-type.outputs.type == 'shopware'
      shell: bash
      run: |
        #!/bin/bash
        set -euo pipefail
        
        echo "ğŸ”§ Preparing Shopware environment for build..."
        
        # Create minimal .env file if it doesn't exist (required for asset building)
        if [ ! -f .env ]; then
          if [ -f .env.dist ]; then
            echo "ğŸ“ Creating .env from .env.dist template"
            cp .env.dist .env
          fi
          echo "âœ… Environment file created"
        fi
        
    - name: 'ğŸ›ï¸ Build Shopware project'
      if: steps.project-type.outputs.type == 'shopware'
      uses: shopwareLabs/build-project-action@v1
      env:
        SHOPWARE_CLI_EXPERIMENTAL_ASSET_CACHING: 1
        
    - name: 'ğŸ…°ï¸ Build Laravel project'
      if: steps.project-type.outputs.type == 'laravel'
      shell: bash
      run: |
        #!/bin/bash
        # Description: Build Laravel project with frontend assets and optimization
        set -euo pipefail
        
        echo "ğŸ…°ï¸ Building Laravel project..."
        
        # Build frontend assets if package.json exists
        if [ -f "package.json" ]; then
          echo "ğŸ“¦ Building frontend assets..."
          if ! npm run build; then
            echo "âŒ Error: Frontend asset build failed"
            exit 1
          fi
          echo "âœ… Frontend assets built successfully"
        else
          echo "ğŸ’¡ No package.json found, skipping frontend build"
        fi
        
        # Optimize Laravel application
        echo "âš¡ Optimizing Laravel application..."
        if ! php artisan optimize; then
          echo "âŒ Error: Laravel optimization failed"
          exit 1
        fi
        
        echo "âœ… Laravel build completed successfully"
        
    - name: 'ğŸ¼ Build Symfony project'
      if: steps.project-type.outputs.type == 'symfony'
      shell: bash
      run: |
        #!/bin/bash
        # Description: Build Symfony project with frontend assets and cache warmup
        set -euo pipefail
        
        echo "ğŸ¼ Building Symfony project..."
        
        # Build frontend assets if package.json exists
        if [ -f "package.json" ]; then
          echo "ğŸ“¦ Building frontend assets..."
          if ! npm run build; then
            echo "âŒ Error: Frontend asset build failed"
            exit 1
          fi
          echo "âœ… Frontend assets built successfully"
        else
          echo "ğŸ’¡ No package.json found, skipping frontend build"
        fi
        
        # Warm up Symfony cache for production
        echo "ğŸ”¥ Warming up Symfony cache..."
        if ! bin/console cache:warmup --env=prod; then
          echo "âŒ Error: Symfony cache warmup failed"
          exit 1
        fi
        
        echo "âœ… Symfony build completed successfully"
        
    - name: 'ğŸ”§ Run custom build commands'
      if: steps.config.outputs.build_commands != ''
      shell: bash
      run: |
        #!/bin/bash
        # Description: Execute custom build commands from configuration
        set -euo pipefail
        
        echo "ğŸ”§ Running custom build commands from configuration..."
        
        # Execute each build command with error handling
        command_count=0
        while IFS= read -r command; do
          if [ -n "$command" ]; then
            command_count=$((command_count + 1))
            echo "ğŸš€ Executing command $command_count: $command"
            
            if ! eval "$command"; then
              echo "âŒ Error: Custom build command failed: $command"
              exit 1
            fi
            
            echo "âœ… Command $command_count completed successfully"
          fi
        done <<< "${{ steps.config.outputs.build_commands }}"
        
        if [ $command_count -eq 0 ]; then
          echo "ğŸ’¡ No custom build commands found"
        else
          echo "âœ… All $command_count custom build commands completed successfully"
        fi
        
    - name: 'ğŸ—‘ï¸ Remove excluded files'
      shell: bash
      run: |
        #!/bin/bash
        # Description: Remove files and directories based on exclusion patterns
        set -euo pipefail
        
        echo "ğŸ—‘ï¸ Removing excluded files and directories..."
        
        # Process exclude patterns with improved safety
        pattern_count=0
        while IFS= read -r pattern; do
          if [ -n "$pattern" ] && [ "$pattern" != "null" ]; then
            pattern_count=$((pattern_count + 1))
            echo "ğŸ” Processing exclusion pattern $pattern_count: $pattern"
            
            # Sanitize pattern to prevent dangerous operations
            if [[ "$pattern" =~ ^[./]*$ ]] || [[ "$pattern" == "/" ]]; then
              echo "âš ï¸  Skipping dangerous pattern: $pattern"
              continue
            fi
            
            # Use find with safer removal patterns
            if [[ "$pattern" == *"/*" ]]; then
              # Directory pattern - remove directories matching pattern
              find . -path "./$pattern" -type d -print0 2>/dev/null | while IFS= read -r -d '' dir; do
                echo "  ğŸ—‚ï¸ Removing directory: $dir"
                rm -rf "$dir" 2>/dev/null || echo "  âš ï¸  Could not remove: $dir"
              done
            else
              # File pattern - remove files matching pattern
              find . -name "$pattern" -type f -print0 2>/dev/null | while IFS= read -r -d '' file; do
                echo "  ğŸ“„ Removing file: $file"
                rm -f "$file" 2>/dev/null || echo "  âš ï¸  Could not remove: $file"
              done
            fi
          fi
        done <<< "${{ steps.config.outputs.exclude_patterns }}"
        
        if [ $pattern_count -eq 0 ]; then
          echo "ğŸ’¡ No exclusion patterns found"
        else
          echo "âœ… Processed $pattern_count exclusion patterns"
        fi
        
    - name: 'ğŸ“Š Create build metadata'
      shell: bash
      run: |
        #!/bin/bash
        # Description: Create comprehensive build metadata file
        set -euo pipefail
        
        echo "ğŸ“Š Creating build metadata..."
        
        # Get current timestamp in ISO format
        BUILD_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        
        # Determine reference type and name
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          REF_NAME="${{ github.ref_name }}"
          REF_TYPE="tag"
        else
          REF_NAME="${{ github.ref_name }}"
          REF_TYPE="branch"
        fi
        
        # Create build-info.json with comprehensive metadata
        cat > build-info.json << EOF
        {
          "project_name": "${{ steps.config.outputs.project_name }}",
          "project_type": "${{ steps.project-type.outputs.type }}",
          "commit_sha": "${{ github.sha }}",
          "commit_ref": "${{ github.ref }}",
          "ref_name": "$REF_NAME",
          "ref_type": "$REF_TYPE",
          "build_timestamp": "$BUILD_TIMESTAMP",
          "workflow_run_id": "${{ github.run_id }}",
          "workflow_run_number": "${{ github.run_number }}",
          "actor": "${{ github.actor }}",
          "repository": "${{ github.repository }}",
          "event_name": "${{ github.event_name }}"
        }
        EOF
        
        # Validate JSON syntax
        if ! python3 -m json.tool build-info.json >/dev/null 2>&1; then
          echo "âŒ Error: Generated build metadata has invalid JSON syntax"
          exit 1
        fi
        
        echo "âœ… Build metadata created successfully:"
        echo "  ğŸ“„ File: build-info.json"
        echo "  ğŸ—ï¸  Project: ${{ steps.config.outputs.project_name }} (${{ steps.project-type.outputs.type }})"
        echo "  ğŸ“ Commit: ${{ github.sha }}"
        echo "  ğŸ·ï¸  Reference: $REF_NAME ($REF_TYPE)"
        echo "  â° Timestamp: $BUILD_TIMESTAMP"