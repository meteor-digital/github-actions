name: 'Setup Environment'
description: 'Sets up PHP, Node.js, and installs dependencies with caching'

inputs:
  config_file:
    description: 'Path to CI configuration file'
    required: false
    default: '.github/pipeline-config.yml'
  composer_with_dev:
    description: 'Install dev dependencies (yes/no)'
    required: false
    default: 'yes'
  composer_auth:
    description: 'Composer authentication JSON'
    required: false
    default: '{}'
  node_skip_setup:
    description: 'Whether to skip Node.js setup'
    required: false
    default: 'false'

outputs:
  php_version:
    description: 'PHP version that was configured'
    value: ${{ steps.config.outputs.php_version }}
  node_version:
    description: 'Node.js version that was configured'
    value: ${{ steps.config.outputs.node_version }}
  project_type:
    description: 'Detected project type (shopware, laravel, symfony)'
    value: ${{ steps.project-type.outputs.type }}
  cache_hit:
    description: 'Whether dependencies were restored from cache'
    value: ${{ steps.cache-deps.outputs.cache-hit }}

runs:
  using: 'composite'
  steps:
    - name: Detect project type
      id: project-type
      uses: meteor-digital/github-actions/.github/actions/detect-project-type@main

    - name: Read configuration
      id: config
      uses: meteor-digital/github-actions/.github/actions/parse-pipeline-config@main
      with:
        config_file: ${{ inputs.config_file }}
        
    - name: 'ğŸ”‘ Generate dependency cache key'
      id: cache-key-gen
      shell: bash
      run: |
        #!/bin/bash
        # Description: Generate cache key for dependencies based on lock files
        set -euo pipefail
        
        # Determine dev dependency suffix
        DEV_SUFFIX=""
        if [[ "${{ inputs.composer_with_dev }}" == "no" ]]; then
          DEV_SUFFIX="-nodev"
          echo "ğŸ“¦ Cache mode: Production (no dev dependencies)"
        else
          echo "ğŸ“¦ Cache mode: Development (with dev dependencies)"
        fi
        
        # Generate hash from dependency files
        COMPOSER_HASH="${{ hashFiles('composer.json', 'composer.lock') }}"
        NODE_HASH="${{ hashFiles('package.json', 'package-lock.json') }}"
        
        # Create cache key
        CACHE_KEY="deps-${COMPOSER_HASH}-${NODE_HASH}${DEV_SUFFIX}"
        echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
        
        echo "ğŸ”‘ Generated cache key: $CACHE_KEY"
        echo "  ğŸ“„ Composer files hash: $COMPOSER_HASH"
        echo "  ğŸ“„ Node files hash: $NODE_HASH"

    - name: 'ğŸ“¦ Restore cached dependencies'
      uses: actions/cache/restore@v4
      id: cache-deps
      with:
        path: |
          vendor/
          node_modules/
          ~/.composer/cache/
          ~/.npm/
        key: ${{ steps.cache-key-gen.outputs.key }}

    - name: 'ğŸ˜ Setup PHP ${{ steps.config.outputs.php_version }}'
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ steps.config.outputs.php_version }}
        extensions: ${{ steps.config.outputs.php_extensions }}
        tools: composer:v2
        coverage: none

    - name: 'ğŸŸ¢ Setup Node.js ${{ steps.config.outputs.node_version }}'
      if: inputs.node_skip_setup == 'false' || (inputs.node_skip_setup != 'true' && hashFiles('package.json') != '')
      uses: actions/setup-node@v4
      with:
        node-version: ${{ steps.config.outputs.node_version }}
        cache: ${{ hashFiles('package.json') != '' && 'npm' || '' }}

    - name: 'ğŸ“¥ Install dependencies'
      if: steps.cache-deps.outputs.cache-hit != 'true'
      uses: meteor-digital/github-actions/.github/actions/composer-setup@main
      with:
        args: '--prefer-dist --no-progress --no-interaction --optimize-autoloader --no-scripts'
        with_dev: ${{ inputs.composer_with_dev }}
      env:
        COMPOSER_AUTH: ${{ inputs.composer_auth }}

    - name: 'ğŸ’¾ Save dependency cache'
      if: steps.cache-deps.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: |
          vendor/
          node_modules/
          ~/.composer/cache/
          ~/.npm/
        key: ${{ steps.cache-key-gen.outputs.key }}

    - name: 'ğŸ¯ Framework-specific setup'
      shell: bash
      run: |
        #!/bin/bash
        # Description: Perform framework-specific environment setup
        set -euo pipefail
        
        PROJECT_TYPE="${{ steps.project-type.outputs.type }}"
        echo "ğŸ¯ Running framework-specific setup for: $PROJECT_TYPE"
        
        case $PROJECT_TYPE in
          "shopware")
            echo "ğŸ›ï¸  Setting up Shopware environment..."
            
            # Verify Shopware project structure
            if [ -f ".shopware-project.yml" ]; then
              echo "âœ… Shopware project configuration found"
            fi
            
            # Check for required Shopware directories
            [ -d "config" ] && echo "âœ… Config directory found" || echo "âš ï¸  Config directory not found"
            [ -d "public" ] && echo "âœ… Public directory found" || echo "âš ï¸  Public directory not found"
            [ -d "src" ] && echo "âœ… Source directory found" || echo "âš ï¸  Source directory not found"
            
            # Shopware CLI will be installed by build-project action when needed
            echo "ğŸ”§ Shopware environment setup complete"
            ;;
            
          "laravel")
            echo "ğŸ…°ï¸  Setting up Laravel environment..."
            
            # Verify Laravel project structure
            if [ -f "artisan" ]; then
              echo "âœ… Laravel artisan command found"
            fi
            
            # Check for required Laravel directories
            [ -d "app" ] && echo "âœ… App directory found" || echo "âš ï¸  App directory not found"
            [ -d "config" ] && echo "âœ… Config directory found" || echo "âš ï¸  Config directory not found"
            [ -d "resources" ] && echo "âœ… Resources directory found" || echo "âš ï¸  Resources directory not found"
            
            echo "ğŸ”§ Laravel environment setup complete"
            ;;
            
          "symfony")
            echo "ğŸ¼ Setting up Symfony environment..."
            
            # Verify Symfony project structure
            if [ -f "symfony.lock" ]; then
              echo "âœ… Symfony lock file found"
            fi
            
            # Check for required Symfony directories
            [ -d "src" ] && echo "âœ… Source directory found" || echo "âš ï¸  Source directory not found"
            [ -d "config" ] && echo "âœ… Config directory found" || echo "âš ï¸  Config directory not found"
            [ -f "bin/console" ] && echo "âœ… Symfony console found" || echo "âš ï¸  Symfony console not found"
            
            echo "ğŸ”§ Symfony environment setup complete"
            ;;
            
          *)
            echo "ğŸ”§ Generic project setup complete"
            ;;
        esac
        
        echo "ğŸ‰ Environment setup completed successfully!"