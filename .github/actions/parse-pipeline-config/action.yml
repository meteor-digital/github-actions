name: 'Parse Pipeline Configuration'
description: 'Parses unified CI/CD pipeline configuration from YAML file'

inputs:
  config_file:
    description: 'Path to pipeline configuration file'
    required: false
    default: '.github/pipeline-config.yml'
  environment:
    description: 'Target environment (required for deployment parsing)'
    required: false
  project_type:
    description: 'Project type (shopware, laravel, symfony, package, generic)'
    required: false

outputs:
  # CI Configuration outputs
  project_name:
    description: 'Project name from configuration'
    value: ${{ steps.parse_ci.outputs.project_name }}
  php_version:
    description: 'PHP version from configuration'
    value: ${{ steps.parse_ci.outputs.php_version }}
  node_version:
    description: 'Node.js version from configuration'
    value: ${{ steps.parse_ci.outputs.node_version }}
  php_extensions:
    description: 'PHP extensions from configuration'
    value: ${{ steps.parse_ci.outputs.php_extensions }}
  build_commands:
    description: 'Build commands from configuration'
    value: ${{ steps.parse_ci.outputs.build_commands }}
  exclude_patterns:
    description: 'File exclusion patterns from configuration'
    value: ${{ steps.parse_ci.outputs.exclude_patterns }}
  retention_days:
    description: 'Artifact retention days from configuration'
    value: ${{ steps.parse_ci.outputs.retention_days }}
  notification_webhook:
    description: 'Notification webhook URL for notifications'
    value: ${{ steps.parse_ci.outputs.notification_webhook }}
  
  # Quality Configuration outputs
  enabled_tools:
    description: 'Enabled quality tools from configuration'
    value: ${{ steps.parse_ci.outputs.enabled_tools }}
  php_cs_fixer_bin:
    description: 'PHP-CS-Fixer binary path'
    value: ${{ steps.parse_ci.outputs.php_cs_fixer_bin }}
  psalm_bin:
    description: 'Psalm binary path'
    value: ${{ steps.parse_ci.outputs.psalm_bin }}
  phpstan_bin:
    description: 'PHPStan binary path'
    value: ${{ steps.parse_ci.outputs.phpstan_bin }}
  rector_bin:
    description: 'Rector binary path'
    value: ${{ steps.parse_ci.outputs.rector_bin }}
  phpunit_bin:
    description: 'PHPUnit binary path'
    value: ${{ steps.parse_ci.outputs.phpunit_bin }}
  phpunuhi_bin:
    description: 'PHPUnuhi binary path'
    value: ${{ steps.parse_ci.outputs.phpunuhi_bin }}
  
  # Deployment Configuration outputs
  host:
    description: 'Deployment host'
    value: ${{ steps.parse_deployment.outputs.host }}
  path:
    description: 'Deployment path'
    value: ${{ steps.parse_deployment.outputs.path }}
  provider:
    description: 'Hosting provider'
    value: ${{ steps.parse_deployment.outputs.provider }}
  ssh_user:
    description: 'SSH username for deployment'
    value: ${{ steps.parse_deployment.outputs.ssh_user }}
  ssh_port:
    description: 'SSH port'
    value: ${{ steps.parse_deployment.outputs.ssh_port }}
  php_service:
    description: 'PHP service name'
    value: ${{ steps.parse_deployment.outputs.php_service }}
  maintenance_mode:
    description: 'Enable maintenance mode'
    value: ${{ steps.parse_deployment.outputs.maintenance_mode }}
  keep_releases:
    description: 'Number of releases to keep'
    value: ${{ steps.parse_deployment.outputs.keep_releases }}
  messenger_worker_id:
    description: 'Messenger worker ID'
    value: ${{ steps.parse_deployment.outputs.messenger_worker_id }}
  shared_folders:
    description: 'Shared folders list'
    value: ${{ steps.apply_overrides.outputs.shared_folders }}
  pre_deploy_commands:
    description: 'Pre-deployment commands'
    value: ${{ steps.apply_overrides.outputs.pre_deploy_commands }}
  post_deploy_commands:
    description: 'Post-deployment commands'
    value: ${{ steps.apply_overrides.outputs.post_deploy_commands }}
  migration_command:
    description: 'Database migration command'
    value: ${{ steps.framework_defaults.outputs.migration_command }}
  maintenance_enable_cmd:
    description: 'Maintenance enable command'
    value: ${{ steps.framework_defaults.outputs.maintenance_enable_cmd }}
  maintenance_disable_cmd:
    description: 'Maintenance disable command'
    value: ${{ steps.framework_defaults.outputs.maintenance_disable_cmd }}

runs:
  using: 'composite'
  steps:
    - name: 'üîç Validate inputs and config file'
      shell: bash
      run: |
        CONFIG_FILE="${{ inputs.config_file }}"
        ENVIRONMENT="${{ inputs.environment }}"
        
        # Validate required inputs
        if [ -z "$CONFIG_FILE" ]; then
          echo "‚ùå Error: config_file input is required"
          exit 1
        fi
        
        # Validate environment format if provided
        if [ -n "$ENVIRONMENT" ] && ! [[ "$ENVIRONMENT" =~ ^[a-zA-Z0-9-]+$ ]]; then
          echo "‚ùå Error: Invalid environment name '$ENVIRONMENT'"
          echo "üí° Environment names must contain only letters, numbers, and hyphens"
          exit 1
        fi
        
        # Validate configuration file exists and has valid YAML syntax
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "‚ùå Error: Configuration file not found: $CONFIG_FILE"
          echo "üí° Please create the file or check the path"
          exit 1
        fi
        
        if ! yq eval '.' "$CONFIG_FILE" >/dev/null 2>&1; then
          echo "‚ùå Error: Invalid YAML syntax in $CONFIG_FILE"
          echo "üí° Please check for indentation errors, missing quotes, or invalid characters"
          exit 1
        fi
        
        echo "‚úÖ Input validation and config file validation completed"

    - name: 'üì¶ Parse CI configuration'
      id: parse_ci
      shell: bash
      run: |
        CONFIG_FILE="${{ inputs.config_file }}"
        
        echo "üì¶ Parsing CI configuration..."
        
        # Initialize with defaults
        PROJECT_NAME="${{ github.event.repository.name }}"
        NODE_VERSION="18"
        PHP_EXTENSIONS="mbstring, intl, gd, xml, zip, curl, opcache"
        RETENTION_DAYS="1"
        EXCLUDE_PATTERNS="*.git*
        node_modules/*
        tests/*
        *.md
        devenv*
        .editorconfig
        .env*
        .vscode
        phpunit.xml*
        psalm*
        rector.php
        .php-cs-fixer.php
        grumphp.yml
        bitbucket-pipelines.yml
        .shopware-project.yml
        Jenkinsfile
        patch/*
        scripts/*
        *.log
        *.cache"
        
        # Parse values from config
        PARSED_PROJECT_NAME=$(yq eval '.project.name' "$CONFIG_FILE" 2>/dev/null)
        PARSED_PHP_VERSION=$(yq eval '.runtime.php_version' "$CONFIG_FILE" 2>/dev/null)
        PARSED_NODE_VERSION=$(yq eval '.runtime.node_version' "$CONFIG_FILE" 2>/dev/null)
        PARSED_PHP_EXTENSIONS=$(yq eval '.runtime.php_extensions' "$CONFIG_FILE" 2>/dev/null)
        PARSED_RETENTION_DAYS=$(yq eval '.build.artifacts.retention_days' "$CONFIG_FILE" 2>/dev/null)
        NOTIFICATION_WEBHOOK=$(yq eval '.notifications.notification_webhook' "$CONFIG_FILE" 2>/dev/null)
        
        # Apply parsed values with validation
        [ -n "$PARSED_PROJECT_NAME" ] && [ "$PARSED_PROJECT_NAME" != "null" ] && PROJECT_NAME="$PARSED_PROJECT_NAME"
        
        if [ -n "$PARSED_PHP_VERSION" ] && [ "$PARSED_PHP_VERSION" != "null" ]; then
          if [[ "$PARSED_PHP_VERSION" =~ ^[0-9]+\.[0-9]+$ ]]; then
            PHP_VERSION="$PARSED_PHP_VERSION"
          else
            echo "‚ùå Error: Invalid PHP version format '$PARSED_PHP_VERSION' (expected: X.Y)"
            exit 1
          fi
        else
          echo "‚ùå Error: PHP version is required in runtime.php_version"
          exit 1
        fi
        
        if [ -n "$PARSED_NODE_VERSION" ] && [ "$PARSED_NODE_VERSION" != "null" ]; then
          if [[ "$PARSED_NODE_VERSION" =~ ^[0-9]+$ ]]; then
            NODE_VERSION="$PARSED_NODE_VERSION"
          else
            echo "‚ùå Error: Invalid Node.js version format '$PARSED_NODE_VERSION' (expected: integer)"
            exit 1
          fi
        fi
        
        [ -n "$PARSED_PHP_EXTENSIONS" ] && [ "$PARSED_PHP_EXTENSIONS" != "null" ] && PHP_EXTENSIONS="$PARSED_PHP_EXTENSIONS"
        
        if [ -n "$PARSED_RETENTION_DAYS" ] && [ "$PARSED_RETENTION_DAYS" != "null" ]; then
          if [[ "$PARSED_RETENTION_DAYS" =~ ^[0-9]+$ ]]; then
            RETENTION_DAYS="$PARSED_RETENTION_DAYS"
          else
            echo "‚ùå Error: Invalid retention_days format '$PARSED_RETENTION_DAYS' (expected: integer)"
            exit 1
          fi
        fi
        
        # Parse build commands and exclude patterns
        BUILD_COMMANDS=$(yq eval -r '.build.build_commands[]' "$CONFIG_FILE" 2>/dev/null || echo "")
        EXCLUDE_PATTERNS_YAML=$(yq eval '.build.exclude_patterns' "$CONFIG_FILE" 2>/dev/null)
        [ -n "$EXCLUDE_PATTERNS_YAML" ] && [ "$EXCLUDE_PATTERNS_YAML" != "null" ] && EXCLUDE_PATTERNS="$EXCLUDE_PATTERNS_YAML"
        
        # Parse quality configuration
        DEFAULT_TOOLS='["php-cs-fixer", "psalm", "phpstan", "rector", "phpunit", "composer-validate"]'
        DEFAULT_PHP_CS_FIXER="./vendor/bin/php-cs-fixer"
        DEFAULT_PSALM="./vendor/bin/psalm"
        DEFAULT_PHPSTAN="./vendor/bin/phpstan"
        DEFAULT_RECTOR="./vendor/bin/rector"
        DEFAULT_PHPUNIT="./vendor/bin/phpunit"
        DEFAULT_PHPUNUHI="./vendor/bin/phpunuhi"
        
        # Parse enabled tools from quality_checks section
        ENABLED_TOOLS=$(yq eval '.quality_checks.enabled_tools | @json' "$CONFIG_FILE" 2>/dev/null)
        if [ "$ENABLED_TOOLS" = "null" ] || [ -z "$ENABLED_TOOLS" ]; then
          ENABLED_TOOLS="$DEFAULT_TOOLS"
        fi
        
        # Parse tool binary overrides from quality_checks section
        PHP_CS_FIXER_BIN=$(yq eval '.quality_checks.tool_binaries.php-cs-fixer // ""' "$CONFIG_FILE" 2>/dev/null)
        PSALM_BIN=$(yq eval '.quality_checks.tool_binaries.psalm // ""' "$CONFIG_FILE" 2>/dev/null)
        PHPSTAN_BIN=$(yq eval '.quality_checks.tool_binaries.phpstan // ""' "$CONFIG_FILE" 2>/dev/null)
        RECTOR_BIN=$(yq eval '.quality_checks.tool_binaries.rector // ""' "$CONFIG_FILE" 2>/dev/null)
        PHPUNIT_BIN=$(yq eval '.quality_checks.tool_binaries.phpunit // ""' "$CONFIG_FILE" 2>/dev/null)
        PHPUNUHI_BIN=$(yq eval '.quality_checks.tool_binaries.phpunuhi // ""' "$CONFIG_FILE" 2>/dev/null)
        
        # Use defaults if not specified
        [ -z "$PHP_CS_FIXER_BIN" ] && PHP_CS_FIXER_BIN="$DEFAULT_PHP_CS_FIXER"
        [ -z "$PSALM_BIN" ] && PSALM_BIN="$DEFAULT_PSALM"
        [ -z "$PHPSTAN_BIN" ] && PHPSTAN_BIN="$DEFAULT_PHPSTAN"
        [ -z "$RECTOR_BIN" ] && RECTOR_BIN="$DEFAULT_RECTOR"
        [ -z "$PHPUNIT_BIN" ] && PHPUNIT_BIN="$DEFAULT_PHPUNIT"
        [ -z "$PHPUNUHI_BIN" ] && PHPUNUHI_BIN="$DEFAULT_PHPUNUHI"
        
        # Set outputs
        echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
        echo "php_version=$PHP_VERSION" >> $GITHUB_OUTPUT
        echo "node_version=$NODE_VERSION" >> $GITHUB_OUTPUT
        echo "php_extensions=$PHP_EXTENSIONS" >> $GITHUB_OUTPUT
        echo "retention_days=$RETENTION_DAYS" >> $GITHUB_OUTPUT
        echo "notification_webhook=$NOTIFICATION_WEBHOOK" >> $GITHUB_OUTPUT
        echo "enabled_tools=$ENABLED_TOOLS" >> $GITHUB_OUTPUT
        echo "php_cs_fixer_bin=$PHP_CS_FIXER_BIN" >> $GITHUB_OUTPUT
        echo "psalm_bin=$PSALM_BIN" >> $GITHUB_OUTPUT
        echo "phpstan_bin=$PHPSTAN_BIN" >> $GITHUB_OUTPUT
        echo "rector_bin=$RECTOR_BIN" >> $GITHUB_OUTPUT
        echo "phpunit_bin=$PHPUNIT_BIN" >> $GITHUB_OUTPUT
        echo "phpunuhi_bin=$PHPUNUHI_BIN" >> $GITHUB_OUTPUT
        echo "build_commands<<EOF" >> $GITHUB_OUTPUT
        echo "$BUILD_COMMANDS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "exclude_patterns<<EOF" >> $GITHUB_OUTPUT
        echo "$EXCLUDE_PATTERNS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: 'üèóÔ∏è Load framework defaults'
      id: framework_defaults
      if: inputs.project_type != ''
      shell: bash
      run: |
        PROJECT_TYPE="${{ inputs.project_type }}"
        
        echo "üèóÔ∏è Loading framework defaults for: $PROJECT_TYPE"
        
        case "$PROJECT_TYPE" in
          'shopware')
            echo "‚úÖ Loading Shopware framework defaults"
            SHARED_FOLDERS="files
        public/media
        public/sitemap
        public/thumbnail
        config/jwt
        var/log"
            PRE_DEPLOY_COMMANDS="bin/console cache:warmup --no-optional-warmers"
            POST_DEPLOY_COMMANDS="bin/console theme:dump --no-interaction
        bin/console theme:compile --active-only
        bin/console asset:install
        touch install.lock"
            MIGRATION_COMMAND="bin/console database:migrate --all && bin/console database:migrate --all ${{ steps.parse_ci.outputs.project_name }}"
            MAINTENANCE_ENABLE_CMD="bin/console sales-channel:maintenance:enable --all"
            MAINTENANCE_DISABLE_CMD="bin/console sales-channel:maintenance:disable --all"
            ;;
          'laravel')
            echo "‚úÖ Loading Laravel framework defaults"
            SHARED_FOLDERS="storage
        bootstrap/cache"
            PRE_DEPLOY_COMMANDS=""
            POST_DEPLOY_COMMANDS="php artisan config:cache
        php artisan route:cache
        php artisan view:cache
        php artisan optimize"
            MIGRATION_COMMAND="php artisan migrate --force"
            MAINTENANCE_ENABLE_CMD="php artisan down"
            MAINTENANCE_DISABLE_CMD="php artisan up"
            ;;
          'symfony')
            echo "‚úÖ Loading Symfony framework defaults"
            SHARED_FOLDERS="var
        public/uploads"
            PRE_DEPLOY_COMMANDS="bin/console cache:warmup --no-optional-warmers"
            POST_DEPLOY_COMMANDS="bin/console doctrine:migrations:migrate --no-interaction"
            MIGRATION_COMMAND="bin/console doctrine:migrations:migrate --no-interaction"
            MAINTENANCE_ENABLE_CMD="touch maintenance.html"
            MAINTENANCE_DISABLE_CMD="rm -f maintenance.html"
            ;;
          'package'|'generic')
            echo "‚úÖ Loading package/generic defaults (no deployment)"
            SHARED_FOLDERS=""
            PRE_DEPLOY_COMMANDS=""
            POST_DEPLOY_COMMANDS=""
            MIGRATION_COMMAND=""
            MAINTENANCE_ENABLE_CMD=""
            MAINTENANCE_DISABLE_CMD=""
            ;;
          *)
            echo "‚ùå Error: No defaults found for project type '$PROJECT_TYPE'"
            echo "Supported project types: shopware, laravel, symfony, package, generic"
            exit 1
            ;;
        esac
        
        # Set framework defaults as outputs
        echo "shared_folders<<EOF" >> $GITHUB_OUTPUT
        echo "$SHARED_FOLDERS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "pre_deploy_commands<<EOF" >> $GITHUB_OUTPUT
        echo "$PRE_DEPLOY_COMMANDS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "post_deploy_commands<<EOF" >> $GITHUB_OUTPUT
        echo "$POST_DEPLOY_COMMANDS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "migration_command=$MIGRATION_COMMAND" >> $GITHUB_OUTPUT
        echo "maintenance_enable_cmd=$MAINTENANCE_ENABLE_CMD" >> $GITHUB_OUTPUT
        echo "maintenance_disable_cmd=$MAINTENANCE_DISABLE_CMD" >> $GITHUB_OUTPUT

    - name: 'üöÄ Parse deployment configuration'
      id: parse_deployment
      if: inputs.environment != '' && inputs.project_type != ''
      shell: bash
      run: |
        CONFIG_FILE="${{ inputs.config_file }}"
        ENVIRONMENT="${{ inputs.environment }}"
        
        echo "üöÄ Parsing deployment configuration for environment: $ENVIRONMENT"
        
        # Parse deployment configuration using yq
        HOST=$(yq eval ".deployment.environments.${ENVIRONMENT}.host" "$CONFIG_FILE" 2>/dev/null)
        DEPLOY_PATH=$(yq eval ".deployment.environments.${ENVIRONMENT}.path" "$CONFIG_FILE" 2>/dev/null)
        MAINTENANCE_MODE=$(yq eval ".deployment.environments.${ENVIRONMENT}.maintenance_mode" "$CONFIG_FILE" 2>/dev/null)
        SSH_PORT=$(yq eval ".deployment.environments.${ENVIRONMENT}.ssh_port" "$CONFIG_FILE" 2>/dev/null)
        SSH_USER=$(yq eval ".deployment.environments.${ENVIRONMENT}.ssh_user" "$CONFIG_FILE" 2>/dev/null)
        
        # Parse hosting configuration (environment-specific with fallback)
        PROVIDER=$(yq eval ".deployment.environments.${ENVIRONMENT}.provider" "$CONFIG_FILE" 2>/dev/null)
        if [ -z "$PROVIDER" ] || [ "$PROVIDER" = "null" ]; then
          PROVIDER=$(yq eval ".deployment.hosting.provider" "$CONFIG_FILE" 2>/dev/null)
        fi

        PHP_SERVICE=$(yq eval ".deployment.environments.${ENVIRONMENT}.php_service" "$CONFIG_FILE" 2>/dev/null)
        if [ -z "$PHP_SERVICE" ] || [ "$PHP_SERVICE" = "null" ]; then
          PHP_SERVICE=$(yq eval ".deployment.hosting.php_service" "$CONFIG_FILE" 2>/dev/null)
        fi
        
        # Parse messenger worker ID (environment-specific with fallback)
        MESSENGER_WORKER_ID=$(yq eval ".deployment.environments.${ENVIRONMENT}.messenger_worker_id" "$CONFIG_FILE" 2>/dev/null)
        if [ -z "$MESSENGER_WORKER_ID" ] || [ "$MESSENGER_WORKER_ID" = "null" ]; then
          MESSENGER_WORKER_ID=$(yq eval ".deployment.hosting.messenger_worker_id" "$CONFIG_FILE" 2>/dev/null)
        fi
        
        # Parse cleanup configuration
        KEEP_RELEASES=$(yq eval ".deployment.cleanup.keep_releases" "$CONFIG_FILE" 2>/dev/null)
        
        # Set defaults for optional values
        [ -z "$SSH_PORT" ] || [ "$SSH_PORT" = "null" ] && SSH_PORT="22"
        [ -z "$MAINTENANCE_MODE" ] || [ "$MAINTENANCE_MODE" = "null" ] && MAINTENANCE_MODE="true"
        [ -z "$KEEP_RELEASES" ] || [ "$KEEP_RELEASES" = "null" ] && KEEP_RELEASES="3"
        [ -z "$PROVIDER" ] || [ "$PROVIDER" = "null" ] && PROVIDER="generic"
        [ -z "$PHP_SERVICE" ] || [ "$PHP_SERVICE" = "null" ] && PHP_SERVICE="php-fpm"
        
        # Validate required deployment configuration
        if [ -z "$HOST" ] || [ "$HOST" = "null" ]; then
          echo "‚ùå Error: Host not configured for environment '$ENVIRONMENT'"
          exit 1
        fi
        
        if [ -z "$DEPLOY_PATH" ] || [ "$DEPLOY_PATH" = "null" ]; then
          echo "‚ùå Error: Path not configured for environment '$ENVIRONMENT'"
          exit 1
        fi
        
        if [ -z "$SSH_USER" ] || [ "$SSH_USER" = "null" ]; then
          echo "‚ùå Error: SSH user not configured"
          exit 1
        fi
        
        # Set deployment outputs
        echo "host=$HOST" >> $GITHUB_OUTPUT
        echo "path=$DEPLOY_PATH" >> $GITHUB_OUTPUT
        echo "provider=$PROVIDER" >> $GITHUB_OUTPUT
        echo "ssh_port=$SSH_PORT" >> $GITHUB_OUTPUT
        echo "ssh_user=$SSH_USER" >> $GITHUB_OUTPUT
        echo "php_service=$PHP_SERVICE" >> $GITHUB_OUTPUT
        echo "maintenance_mode=$MAINTENANCE_MODE" >> $GITHUB_OUTPUT
        echo "keep_releases=$KEEP_RELEASES" >> $GITHUB_OUTPUT
        echo "messenger_worker_id=$MESSENGER_WORKER_ID" >> $GITHUB_OUTPUT

    - name: 'üîß Apply project overrides'
      id: apply_overrides
      if: inputs.environment != '' && inputs.project_type != ''
      shell: bash
      run: |
        CONFIG_FILE="${{ inputs.config_file }}"
        
        echo "üîß Applying project-specific overrides..."
        
        # Start with framework defaults
        SHARED_FOLDERS="${{ steps.framework_defaults.outputs.shared_folders }}"
        PRE_DEPLOY_COMMANDS="${{ steps.framework_defaults.outputs.pre_deploy_commands }}"
        POST_DEPLOY_COMMANDS="${{ steps.framework_defaults.outputs.post_deploy_commands }}"
        
        # Parse project-specific overrides
        PROJECT_SHARED_FOLDERS=$(yq eval '.deployment.shared_folders[]' "$CONFIG_FILE" 2>/dev/null)
        if [ -n "$PROJECT_SHARED_FOLDERS" ] && [ "$PROJECT_SHARED_FOLDERS" != "null" ]; then
          echo "  Overriding shared folders with project configuration"
          SHARED_FOLDERS="$PROJECT_SHARED_FOLDERS"
        fi
        
        PROJECT_PRE_DEPLOY=$(yq eval '.deployment.commands.pre_deploy[]' "$CONFIG_FILE" 2>/dev/null)
        if [ -n "$PROJECT_PRE_DEPLOY" ] && [ "$PROJECT_PRE_DEPLOY" != "null" ]; then
          echo "  Overriding pre-deploy commands with project configuration"
          PRE_DEPLOY_COMMANDS="$PROJECT_PRE_DEPLOY"
        fi
        
        PROJECT_POST_DEPLOY=$(yq eval '.deployment.commands.post_deploy[]' "$CONFIG_FILE" 2>/dev/null)
        if [ -n "$PROJECT_POST_DEPLOY" ] && [ "$PROJECT_POST_DEPLOY" != "null" ]; then
          echo "  Overriding post-deploy commands with project configuration"
          POST_DEPLOY_COMMANDS="$PROJECT_POST_DEPLOY"
        fi
        
        # Set final outputs
        echo "shared_folders<<EOF" >> $GITHUB_OUTPUT
        echo "$SHARED_FOLDERS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "pre_deploy_commands<<EOF" >> $GITHUB_OUTPUT
        echo "$PRE_DEPLOY_COMMANDS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "post_deploy_commands<<EOF" >> $GITHUB_OUTPUT
        echo "$POST_DEPLOY_COMMANDS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: 'üìä Configuration summary'
      shell: bash
      run: |
        echo "üìä Configuration summary:"
        echo "  Project name: ${{ steps.parse_ci.outputs.project_name }}"
        echo "  PHP version: ${{ steps.parse_ci.outputs.php_version }}"
        echo "  Node version: ${{ steps.parse_ci.outputs.node_version }}"
        echo "  PHP extensions: ${{ steps.parse_ci.outputs.php_extensions }}"
        echo "  Retention days: ${{ steps.parse_ci.outputs.retention_days }}"
        echo "  Notification webhook: ${{ steps.parse_ci.outputs.notification_webhook }}"
        echo "  Build commands: $(echo '${{ steps.parse_ci.outputs.build_commands }}' | wc -l) commands"
        echo "  Exclude patterns: $(echo '${{ steps.parse_ci.outputs.exclude_patterns }}' | wc -l) patterns"
        echo "  Quality tools: ${{ steps.parse_ci.outputs.enabled_tools }}"
        echo "  Tool binaries:"
        echo "    php-cs-fixer: ${{ steps.parse_ci.outputs.php_cs_fixer_bin }}"
        echo "    psalm: ${{ steps.parse_ci.outputs.psalm_bin }}"
        echo "    phpstan: ${{ steps.parse_ci.outputs.phpstan_bin }}"
        echo "    rector: ${{ steps.parse_ci.outputs.rector_bin }}"
        echo "    phpunit: ${{ steps.parse_ci.outputs.phpunit_bin }}"
        echo "    phpunuhi: ${{ steps.parse_ci.outputs.phpunuhi_bin }}"
        
        if [ -n "${{ inputs.environment }}" ] && [ -n "${{ inputs.project_type }}" ]; then
          echo "  Environment: ${{ inputs.environment }}"
          echo "  Host: ${{ steps.parse_deployment.outputs.host }}"
          echo "  Path: ${{ steps.parse_deployment.outputs.path }}"
          echo "  Provider: ${{ steps.parse_deployment.outputs.provider }}"
          echo "  SSH Port: ${{ steps.parse_deployment.outputs.ssh_port }}"
          echo "  SSH User: ${{ steps.parse_deployment.outputs.ssh_user }}"
          echo "  PHP Service: ${{ steps.parse_deployment.outputs.php_service }}"
          echo "  Maintenance Mode: ${{ steps.parse_deployment.outputs.maintenance_mode }}"
          echo "  Keep Releases: ${{ steps.parse_deployment.outputs.keep_releases }}"
          echo "  Messenger Worker ID: ${{ steps.parse_deployment.outputs.messenger_worker_id }}"
          echo "  Shared Folders: $(echo '${{ steps.apply_overrides.outputs.shared_folders }}' | wc -l) folders"
          echo "  Pre-deploy Commands: $(echo '${{ steps.apply_overrides.outputs.pre_deploy_commands }}' | wc -l) commands"
          echo "  Post-deploy Commands: $(echo '${{ steps.apply_overrides.outputs.post_deploy_commands }}' | wc -l) commands"
        fi
