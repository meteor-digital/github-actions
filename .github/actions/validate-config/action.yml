name: 'Validate Configuration'
description: 'Validates CI/CD configuration files against JSON schemas'

inputs:
  config_directory:
    description: 'Directory containing configuration files'
    required: false
    default: '.github'
  fail_on_missing:
    description: 'Fail if required configuration files are missing'
    required: false
    default: 'true'
  validate_schemas:
    description: 'Validate against JSON schemas (requires ajv-cli)'
    required: false
    default: 'true'
  check_changed_only:
    description: 'Only validate if config files have changed (for PR checks)'
    required: false
    default: 'false'

outputs:
  validation_result:
    description: 'Validation result (success, warning, error, skipped)'
    value: ${{ steps.validate.outputs.result || steps.skip.outputs.result }}

runs:
  using: 'composite'
  steps:
    - name: 'ðŸ“¥ Checkout code'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for changed-files detection

    - name: 'ðŸ“¥ Checkout schemas'
      uses: actions/checkout@v4
      with:
        repository: meteor-digital/github-actions
        path: .github-actions-schemas
        sparse-checkout: |
          schemas/
        sparse-checkout-cone-mode: false

    - name: 'ðŸ” Check for configuration file changes'
      id: check-changes
      if: inputs.check_changed_only == 'true'
      uses: tj-actions/changed-files@v46
      with:
        files: |
          ${{ inputs.config_directory }}/*-config.yml

    - name: 'ðŸ”§ Install validation tools'
      if: inputs.check_changed_only != 'true' || steps.check-changes.outputs.any_changed == 'true'
      shell: bash
      run: |
        echo "ðŸ“¦ Installing validation tools..."
        
        # Install yq for YAML parsing if not available
        if ! command -v yq >/dev/null 2>&1; then
          echo "  ðŸ“¥ Installing yq..."
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          echo "  âœ… yq installed"
        else
          echo "  âœ… yq already available"
        fi
        
        # Install ajv-cli for JSON schema validation if needed and not available
        if [ "${{ inputs.validate_schemas }}" = "true" ] && ! command -v ajv >/dev/null 2>&1; then
          echo "  ðŸ“¥ Installing ajv-cli..."
          npm install -g ajv-cli
          echo "  âœ… ajv-cli installed"
        else
          echo "  âœ… ajv-cli available or not needed"
        fi

    - name: 'ðŸ” Validate configuration files'
      id: validate
      if: inputs.check_changed_only != 'true' || steps.check-changes.outputs.any_changed == 'true'
      shell: bash
      run: |
        CONFIG_DIR="${{ inputs.config_directory }}"
        FAIL_ON_MISSING="${{ inputs.fail_on_missing }}"
        VALIDATE_SCHEMAS="${{ inputs.validate_schemas }}"
        CHECK_CHANGED_ONLY="${{ inputs.check_changed_only }}"
        
        if [ "$CHECK_CHANGED_ONLY" = "true" ]; then
          echo "ðŸ” Validating changed CI/CD configuration files in $CONFIG_DIR..."
          echo "ðŸ“„ Changed files: ${{ steps.check-changes.outputs.all_changed_files }}"
        else
          echo "ðŸ” Validating all CI/CD configuration files in $CONFIG_DIR..."
        fi
        
        # Required configuration files
        REQUIRED_FILES=(
            "$CONFIG_DIR/pipeline-config.yml"
        )
        
        # Schema mappings
        declare -A SCHEMA_MAP=(
            ["$CONFIG_DIR/pipeline-config.yml"]="pipeline-config.schema.json"
        )
        
        MISSING_FILES=()
        VALIDATION_ERRORS=()
        RESULT="success"
        
        # Check if configuration files exist
        echo "ðŸ“‹ Checking required configuration files..."
        for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
                MISSING_FILES+=("$file")
                echo "  âŒ Missing: $file"
            else
                echo "  âœ… Found: $file"
            fi
        done
        
        # Handle missing files
        if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo ""
            echo "âŒ Missing required configuration files:"
            for file in "${MISSING_FILES[@]}"; do
                echo "  - $file"
            done
            
            if [ "$FAIL_ON_MISSING" = "true" ]; then
                echo ""
                echo "ðŸ’¡ To create configuration files, use one of these methods:"
                echo "  1. Copy from templates: cp templates/shopware/*.yml .github/"
                echo "  2. Run setup script: ./scripts/setup-project.sh shopware level27"
                RESULT="error"
            else
                echo ""
                echo "âš ï¸  Continuing with missing files (fail_on_missing=false)"
                RESULT="warning"
            fi
        fi
        
        # Validate YAML syntax for existing files
        echo ""
        echo "ðŸ“ Validating YAML syntax..."
        for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
                if command -v yq >/dev/null 2>&1; then
                    if yq eval '.' "$file" > /dev/null 2>&1; then
                        echo "  âœ… $file - Valid YAML syntax"
                    else
                        echo "  âŒ $file - Invalid YAML syntax"
                        VALIDATION_ERRORS+=("$file: Invalid YAML syntax")
                        RESULT="error"
                    fi
                else
                    echo "  âš ï¸  $file - Cannot validate YAML (yq not available)"
                fi
            fi
        done
        
        # Validate against JSON schemas
        if [ "$VALIDATE_SCHEMAS" = "true" ]; then
            echo ""
            echo "ðŸ” Validating against JSON schemas..."
            
            if command -v ajv >/dev/null 2>&1; then
                # Get schema directory from checked-out schemas
                SCHEMA_DIR=".github-actions-schemas/schemas"
                
                for file in "${REQUIRED_FILES[@]}"; do
                    if [ -f "$file" ]; then
                        schema_file="${SCHEMA_MAP[$file]}"
                        schema_path="$SCHEMA_DIR/$schema_file"
                        
                        if [ -f "$schema_path" ]; then
                            if ajv validate -s "$schema_path" -d "$file" --verbose 2>/dev/null; then
                                echo "  âœ… $file - Valid against schema"
                            else
                                echo "  âŒ $file - Schema validation failed"
                                error_msg=$(ajv validate -s "$schema_path" -d "$file" 2>&1 | head -5)
                                VALIDATION_ERRORS+=("$file: Schema validation failed - $error_msg")
                                RESULT="error"
                            fi
                        else
                            echo "  âŒ $file - Schema not found at $schema_path"
                            VALIDATION_ERRORS+=("$file: Schema file not found")
                            RESULT="error"
                        fi
                    fi
                done
            else
                echo "  âš ï¸  ajv-cli not available - skipping schema validation"
                echo "     Install with: npm install -g ajv-cli"
                if [ "$VALIDATE_SCHEMAS" = "true" ]; then
                    RESULT="warning"
                fi
            fi
        fi
        
        # Validate configuration content
        echo ""
        echo "ðŸ”§ Validating configuration content..."
        
        # Validate CI configuration
        if [ -f "$CONFIG_DIR/pipeline-config.yml" ]; then
            echo "  ðŸ“‹ Validating CI configuration..."
            
            # Check required fields
            if command -v yq >/dev/null 2>&1; then
                project_name=$(yq eval '.project.name' "$CONFIG_DIR/pipeline-config.yml" 2>/dev/null)
                php_version=$(yq eval '.runtime.php_version' "$CONFIG_DIR/pipeline-config.yml" 2>/dev/null)
                
                if [ -z "$project_name" ] || [ "$project_name" = "null" ]; then
                    echo "    âŒ Missing required field: project.name"
                    VALIDATION_ERRORS+=("pipeline-config.yml: Missing required field project.name")
                    RESULT="error"
                else
                    echo "    âœ… Project name: $project_name"
                fi
                
                if [ -z "$php_version" ] || [ "$php_version" = "null" ]; then
                    echo "    âŒ Missing required field: runtime.php_version"
                    VALIDATION_ERRORS+=("pipeline-config.yml: Missing required field runtime.php_version")
                    RESULT="error"
                else
                    # Validate PHP version format
                    if [[ "$php_version" =~ ^[0-9]+\.[0-9]+$ ]]; then
                        echo "    âœ… PHP version: $php_version"
                    else
                        echo "    âŒ Invalid PHP version format: $php_version (expected: X.Y)"
                        VALIDATION_ERRORS+=("pipeline-config.yml: Invalid PHP version format")
                        RESULT="error"
                    fi
                fi
            fi
        fi
        
        # Validate deployment configuration
        if [ -f "$CONFIG_DIR/pipeline-config.yml" ]; then
            echo "  ðŸš€ Validating deployment configuration..."
            
            if command -v yq >/dev/null 2>&1; then
                # Check if at least one environment is defined
                environments=$(yq eval '.deployment.environments | keys | length' "$CONFIG_DIR/pipeline-config.yml" 2>/dev/null)
                if [ "$environments" = "0" ] || [ "$environments" = "null" ]; then
                    echo "    âŒ No environments defined"
                    VALIDATION_ERRORS+=("pipeline-config.yml: No deployment environments defined")
                    RESULT="error"
                else
                    echo "    âœ… Found $environments environment(s)"
                fi
                
                # Check hosting provider
                provider=$(yq eval '.deployment.hosting.provider' "$CONFIG_DIR/pipeline-config.yml" 2>/dev/null)
                if [ -z "$provider" ] || [ "$provider" = "null" ]; then
                    echo "    âŒ Missing required field: hosting.provider"
                    VALIDATION_ERRORS+=("pipeline-config.yml: Missing required field deployment.hosting.provider")
                    RESULT="error"
                else
                    # Validate provider value
                    case "$provider" in
                        "level27"|"byte"|"hipex"|"hostedpower"|"generic")
                            echo "    âœ… Hosting provider: $provider"
                            ;;
                        *)
                            echo "    âŒ Invalid hosting provider: $provider"
                            echo "       Valid options: level27, byte, hipex, hostedpower, generic"
                            VALIDATION_ERRORS+=("pipeline-config.yml: Invalid hosting provider")
                            RESULT="error"
                            ;;
                    esac
                fi
            fi
        fi
        
        # Summary
        echo ""
        echo "ðŸ“Š Validation Summary:"
        echo "  Result: $RESULT"
        echo "  Missing files: ${#MISSING_FILES[@]}"
        echo "  Validation errors: ${#VALIDATION_ERRORS[@]}"
        
        if [ ${#VALIDATION_ERRORS[@]} -gt 0 ]; then
            echo ""
            echo "âŒ Validation Errors:"
            for error in "${VALIDATION_ERRORS[@]}"; do
                echo "  - $error"
            done
        fi
        
        # Set outputs
        echo "result=$RESULT" >> $GITHUB_OUTPUT
        
        # Convert arrays to newline-separated strings for output
        missing_files_str=""
        for file in "${MISSING_FILES[@]}"; do
            missing_files_str="$missing_files_str$file"$'\n'
        done
        echo "missing_files<<EOF" >> $GITHUB_OUTPUT
        echo "$missing_files_str" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        validation_errors_str=""
        for error in "${VALIDATION_ERRORS[@]}"; do
            validation_errors_str="$validation_errors_str$error"$'\n'
        done
        echo "validation_errors<<EOF" >> $GITHUB_OUTPUT
        echo "$validation_errors_str" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # Exit with error code if validation failed
        if [ "$RESULT" = "error" ]; then
            exit 1
        fi

    - name: 'ðŸ’¡ Skip validation (no changes)'
      id: skip
      if: inputs.check_changed_only == 'true' && steps.check-changes.outputs.any_changed != 'true'
      shell: bash
      run: |
        echo "ðŸ’¡ No configuration files changed, skipping validation"
        echo "âœ… All configuration files are assumed valid"
        echo "result=skipped" >> $GITHUB_OUTPUT