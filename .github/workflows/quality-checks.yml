name: Quality Checks

on:
  workflow_call:
    inputs:
      config_path:
        description: 'Path to pipeline configuration file'
        type: string
        default: '.github/pipeline-config.yml'
      check_changed_files_only:
        description: 'Only check changed files (for fast PR feedback)'
        type: boolean
        default: true
      run_slow_testsuites:
        description: 'Run integration and component tests'
        type: boolean
        default: false
    secrets:
      composer_auth:
        description: 'Composer authentication JSON'
        required: true
      test_env_vars:
        description: 'Additional environment variables for testing (multiline string with KEY=value pairs)'
        required: false

jobs:
  # Setup job to generate dependencies cache for parallel jobs
  setup:
    name: 'ðŸ”§ Setup & Dependencies'
    runs-on: ubuntu-latest
    outputs:
      enabled_tools: ${{ steps.pipeline_config.outputs.enabled_tools }}
      project_name: ${{ steps.pipeline_config.outputs.project_name }}
      project_type: ${{ steps.setup_env.outputs.project_type }}
      php_cs_fixer_bin: ${{ steps.pipeline_config.outputs.php_cs_fixer_bin }}
      psalm_bin: ${{ steps.pipeline_config.outputs.psalm_bin }}
      phpstan_bin: ${{ steps.pipeline_config.outputs.phpstan_bin }}
      rector_bin: ${{ steps.pipeline_config.outputs.rector_bin }}
      phpunit_bin: ${{ steps.pipeline_config.outputs.phpunit_bin }}
      phpunuhi_bin: ${{ steps.pipeline_config.outputs.phpunuhi_bin }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse pipeline configuration
        id: pipeline_config
        uses: meteor-digital/github-actions/.github/actions/parse-pipeline-config@main
        with:
          config_file: ${{ inputs.config_path }}

      # Run the setup job here, so the cache is generated for the parallel jobs below
      - name: Setup environment
        id: setup_env
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: ${{ inputs.config_path }}
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}

# Basic file validation tasks + PHPUnuhi validation (grouped for efficiency)
  file-validation:
    name: 'ðŸ“‹ Validate Files & Translations'
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: ${{ inputs.config_path }}
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}

      - name: Run file validation checks
        if: hashFiles('grumphp.yml') != ''
        shell: bash
        run: |
          echo "ðŸ” Running file validation checks..."
          php ./vendor/bin/grumphp run --tasks="git_blacklist,file_size,xmllint,yamllint,composer" || true

      - name: Run PHPUnuhi validation
        if: hashFiles('phpunuhi.xml') != ''
        shell: bash
        run: |
          echo "ðŸŒ Running translation validation..."
          php ${{ needs.setup.outputs.phpunuhi_bin }} validate:all

      - name: Run custom quality checks
        if: hashFiles(inputs.config_path) != ''
        shell: bash
        run: |
          CONFIG_FILE="${{ inputs.config_path }}"
          
          if [ -f "$CONFIG_FILE" ]; then
            echo "ðŸ”§ Running custom quality checks from pipeline config: $CONFIG_FILE"
            
            # Parse custom checks from quality_checks section in pipeline configuration
            if command -v yq >/dev/null 2>&1; then
              CUSTOM_CHECKS=$(yq eval '.quality_checks.custom_checks' "$CONFIG_FILE" 2>/dev/null)
              if [ "$CUSTOM_CHECKS" != "null" ] && [ -n "$CUSTOM_CHECKS" ]; then
                echo "$CUSTOM_CHECKS" | yq eval '.[] | "echo \"Running: " + .name + "\" && " + .command' -
                echo "$CUSTOM_CHECKS" | yq eval '.[] | .command' - | while read -r command; do
                  echo "ðŸ” Executing: $command"
                  eval "$command"
                done
              else
                echo "ðŸ’¡ No custom checks configured in quality_checks section"
              fi
            else
              echo "âš ï¸  yq not available, skipping custom checks parsing"
            fi
          else
            echo "ðŸ’¡ No pipeline configuration file found, skipping custom checks"
          fi

  # PHP code quality checks (fast tasks)
  quick-quality-checks:
    name: 'âš¡ Quick Code Quality'
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: ${{ inputs.config_path }}
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}

      - name: Run Composer Validate
        if: contains(fromJson(needs.setup.outputs.enabled_tools), 'composer-validate')
        shell: bash
        run: |
          echo "ðŸ“¦ Running Composer validation..."
          composer validate --no-check-all --no-check-version --strict

      - name: Run Composer Audit
        if: contains(fromJson(needs.setup.outputs.enabled_tools), 'composer-audit')
        shell: bash
        run: |
          echo "ðŸ”’ Running Composer security audit..."
          composer audit

      - name: Get changed files
        if: inputs.check_changed_files_only == true
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            src/**/*.php
            custom/static-plugins/**/*.php
            tests/**/*.php
            **/*.php
          files_ignore: |
            **/.php-cs-fixer.dist.php
            **/.php-cs-fixer.php

      - name: Check PHP-CS-Fixer config exists
        if: contains(fromJson(needs.setup.outputs.enabled_tools), 'php-cs-fixer')
        id: check-php-cs-fixer-config
        shell: bash
        run: |
          if [ -f ".php-cs-fixer.php" ] || [ -f ".php-cs-fixer.dist.php" ]; then
            echo "config_exists=true" >> $GITHUB_OUTPUT
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: 'ðŸŽ¨ Run PHP-CS-Fixer'
        if: contains(fromJson(needs.setup.outputs.enabled_tools), 'php-cs-fixer') && steps.check-php-cs-fixer-config.outputs.config_exists == 'true' && (inputs.check_changed_files_only != true || steps.changed-files.outputs.any_changed == 'true')
        shell: bash
        run: |
          echo "ðŸŽ¨ Running PHP-CS-Fixer..."
          echo "  ðŸ“„ Using binary: ${{ needs.setup.outputs.php_cs_fixer_bin }}"
          
          # Determine config file
          CONFIG_FILE=""
          if [ -f ".php-cs-fixer.php" ]; then
            CONFIG_FILE=".php-cs-fixer.php"
          elif [ -f ".php-cs-fixer.dist.php" ]; then
            CONFIG_FILE=".php-cs-fixer.dist.php"
          fi

          if [ "${{ inputs.check_changed_files_only }}" = "true" ] && [ "${{ steps.changed-files.outputs.any_changed }}" = "true" ]; then
            echo "  ðŸŽ¯ Checking changed files only: ${{ steps.changed-files.outputs.all_changed_files }}"
            php ${{ needs.setup.outputs.php_cs_fixer_bin }} fix --dry-run --diff --stop-on-violation --path-mode=intersection --config "$CONFIG_FILE" ${{ steps.changed-files.outputs.all_changed_files }}
          else
            echo "  ðŸ“ Checking all files"
            php ${{ needs.setup.outputs.php_cs_fixer_bin }} fix --dry-run --diff --stop-on-violation --config "$CONFIG_FILE"
          fi
          
          echo "âœ… PHP-CS-Fixer completed successfully"

        

  # Psalm static analysis (slow task)
  psalm:
    name: 'ðŸ” Psalm Static Analysis'
    needs: setup
    runs-on: ubuntu-latest
    if: contains(fromJson(needs.setup.outputs.enabled_tools), 'psalm')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: ${{ inputs.config_path }}
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}

      - name: Get changed files
        if: inputs.check_changed_files_only == true
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            src/**/*.php
            custom/static-plugins/**/*.php
            tests/**/*.php
            **/*.php

      - name: Run Psalm on changed files
        if: hashFiles('psalm.xml') != '' && (inputs.check_changed_files_only != true || steps.changed-files.outputs.any_changed == 'true')
        shell: bash
        run: |
          echo "ðŸ” Running Psalm static analysis..."
          echo "  Using binary: ${{ needs.setup.outputs.psalm_bin }}"
          if [ "${{ inputs.check_changed_files_only }}" = "true" ] && [ "${{ steps.changed-files.outputs.any_changed }}" = "true" ]; then
            echo "  Analyzing changed files only: ${{ steps.changed-files.outputs.all_changed_files }}"
            php ${{ needs.setup.outputs.psalm_bin }} --no-progress --no-cache --config=./psalm.xml ${{ steps.changed-files.outputs.all_changed_files }}
          else
            echo "  Analyzing all files"
            php ${{ needs.setup.outputs.psalm_bin }} --no-progress --no-cache --config=./psalm.xml
          fi

  # PHPStan static analysis (new standard)
  phpstan:
    name: 'ðŸ” PHPStan Static Analysis'
    needs: setup
    runs-on: ubuntu-latest
    if: contains(fromJson(needs.setup.outputs.enabled_tools), 'phpstan')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: ${{ inputs.config_path }}
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}

      - name: Get changed files
        if: inputs.check_changed_files_only == true
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            src/**/*.php
            custom/static-plugins/**/*.php
            tests/**/*.php
            **/*.php

      - name: Check PHPStan config exists
        id: check-phpstan-config
        shell: bash
        run: |
          if [ -f "phpstan.neon" ] || [ -f "phpstan.dist.neon" ]; then
            echo "config_exists=true" >> $GITHUB_OUTPUT
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Run PHPStan on changed files
        if: steps.check-phpstan-config.outputs.config_exists == 'true' && (inputs.check_changed_files_only != true || steps.changed-files.outputs.any_changed == 'true')
        shell: bash
        run: |
          echo "ðŸ” Running PHPStan static analysis..."
          echo "  Using binary: ${{ needs.setup.outputs.phpstan_bin }}"
          
          # Determine config file
          CONFIG_FILE=""
          if [ -f "phpstan.neon" ]; then
            CONFIG_FILE="phpstan.neon"
          elif [ -f "phpstan.dist.neon" ]; then
            CONFIG_FILE="phpstan.dist.neon"
          fi

          if [ "${{ inputs.check_changed_files_only }}" = "true" ] && [ "${{ steps.changed-files.outputs.any_changed }}" = "true" ]; then
            echo "  Analyzing changed files only: ${{ steps.changed-files.outputs.all_changed_files }}"
            php ${{ needs.setup.outputs.phpstan_bin }} analyse --configuration="$CONFIG_FILE" ${{ steps.changed-files.outputs.all_changed_files }}
          else
            echo "  Analyzing all files"
            php ${{ needs.setup.outputs.phpstan_bin }} analyse --configuration="$CONFIG_FILE"
          fi

  # Rector code fixing (slow task)
  rector:
    name: 'ðŸ› ï¸ Rector Code Analysis'
    needs: setup
    runs-on: ubuntu-latest
    if: contains(fromJson(needs.setup.outputs.enabled_tools), 'rector')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: ${{ inputs.config_path }}
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}

      - name: Get changed files
        if: inputs.check_changed_files_only == true
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            src/**/*.php
            custom/static-plugins/**/*.php
            tests/**/*.php
            **/*.php
          files_ignore: |
            **/rector.php

      - name: Run Rector on changed files
        if: hashFiles('rector.php') != '' && (inputs.check_changed_files_only != true || steps.changed-files.outputs.any_changed == 'true')
        shell: bash
        run: |
          echo "ðŸ› ï¸ Running Rector code analysis..."
          echo "  Using binary: ${{ needs.setup.outputs.rector_bin }}"
          if [ "${{ inputs.check_changed_files_only }}" = "true" ] && [ "${{ steps.changed-files.outputs.any_changed }}" = "true" ]; then
            echo "  Analyzing changed files only: ${{ steps.changed-files.outputs.all_changed_files }}"
            php ${{ needs.setup.outputs.rector_bin }} process --dry-run --no-progress-bar ${{ steps.changed-files.outputs.all_changed_files }}
          else
            echo "  Analyzing all files"
            php ${{ needs.setup.outputs.rector_bin }} process --dry-run --no-progress-bar
          fi 

  unit-tests:
    name: 'ðŸ§ª PHP Unit Tests'
    needs: setup
    runs-on: ubuntu-latest
    if: contains(fromJson(needs.setup.outputs.enabled_tools), 'phpunit')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: ${{ inputs.config_path }}
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}

      - name: Run unit tests
        shell: bash
        run: |
          echo "ðŸ§ª Running PHP unit tests..."
          echo "  Using binary: ${{ needs.setup.outputs.phpunit_bin }}"
          php ${{ needs.setup.outputs.phpunit_bin }} --testsuite unit
        env:
          SYMFONY_DEPRECATIONS_HELPER: disabled

  slow-testsuites:
    name: 'ðŸ§ª Slow PHP Unit Test Suites'
    needs: setup
    runs-on: ubuntu-latest
    if: contains(fromJson(needs.setup.outputs.enabled_tools), 'phpunit') && inputs.run_slow_testsuites == true
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: shopware
          MYSQL_USER: shopware
          MYSQL_PASSWORD: shopware
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672
        options: --health-cmd="rabbitmqctl status" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: ${{ inputs.config_path }}
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}

      - name: Configure test environment
        shell: bash
        run: |
          echo "ðŸ”§ Configuring test environment..."

          # Run Shopware-specific configuration if it's a Shopware project
          if [ "${{ needs.setup.outputs.project_type }}" == "shopware" ]; then
            echo "  -> Shopware project detected. Applying Shopware-specific configuration."
            
            # Get Shopware version
            SW_VERSION=$(composer show shopware/core | grep '^versions' | awk '{print $NF}' | sed 's/v//' | tr -d '[:space:]')
            echo "    -> Found Shopware version: $SW_VERSION"

            # Handle DATABASE_URL based on version
            if [[ $(printf "%s\n" "6.5.0.0" "$SW_VERSION" | sort -V | head -n1) == "$SW_VERSION" ]] && [[ "$SW_VERSION" != "6.5.0.0" ]]; then
              echo "    -> Using DATABASE_URL without '_test' suffix for older Shopware version."
              echo 'DATABASE_URL=mysql://root:shopware@127.0.0.1:3306/shopware' >> .env.test.local
            else
              echo "    -> Using DATABASE_URL with '_test' suffix."
              echo 'DATABASE_URL=mysql://root:shopware@127.0.0.1:3306/shopware_test' >> .env.test.local
            fi

            # Handle JWT key generation for Shopware < 6.7
            if [[ $(printf "%s\n" "6.7.0.0" "$SW_VERSION" | sort -V | head -n1) == "$SW_VERSION" ]] && [[ "$SW_VERSION" != "6.7.0.0" ]]; then
              echo "    -> Generating JWT keys for older Shopware version using Shopware CLI."
              php bin/console system:generate-jwt-secret --force
            else
              echo "    -> Skipping JWT key generation for Shopware $SW_VERSION."
            fi
          fi

          # Add additional test environment variables
          if [ -n "${{ secrets.test_env_vars }}" ]; then
            echo "ðŸ” Adding test environment variables from secret..."
            cat >> .env.test.local << 'EOF'
          ${{ secrets.test_env_vars }}
          EOF
          else
            echo "ðŸ’¡ No additional test environment variables provided"
          fi

      - name: Run integration tests
        shell: bash
        run: |
          echo "ðŸ§ª Running integration tests..."
          echo "  Using binary: ${{ needs.setup.outputs.phpunit_bin }}"
          php ${{ needs.setup.outputs.phpunit_bin }} --testsuite integration
        env:
          SYMFONY_DEPRECATIONS_HELPER: disabled

      - name: Run component tests
        shell: bash
        run: |
          echo "ðŸ§ª Running component tests..."
          echo "  Using binary: ${{ needs.setup.outputs.phpunit_bin }}"
          php ${{ needs.setup.outputs.phpunit_bin }} --testsuite component
        env:
          SYMFONY_DEPRECATIONS_HELPER: disabled
