name: Quality Checks

on:
  workflow_call:
    inputs:
      config_path:
        description: 'Path to quality configuration file'
        type: string
        default: '.github/quality-config.yml'
      check_changed_files_only:
        description: 'Only check changed files (for fast PR feedback)'
        type: boolean
        default: true
      run_slow_testsuites:
        description: 'Run integration and component tests'
        type: boolean
        default: false
    secrets:
      composer_auth:
        description: 'Composer authentication JSON'
        required: true
      test_env_vars:
        description: 'Additional environment variables for testing (multiline string with KEY=value pairs)'
        required: false

jobs:
  # Setup job to generate dependencies cache for parallel jobs
  setup:
    name: 'ðŸ”§ Setup & Dependencies'
    runs-on: ubuntu-latest
    outputs:
      enabled_tools: ${{ steps.quality_config.outputs.enabled_tools }}
      project_name: ${{ steps.ci_config.outputs.project_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Read CI configuration
        id: ci_config
        uses: meteor-digital/github-actions/.github/actions/parse-ci-config@main
        with:
          config_file: '.github/ci-config.yml'

      - name: Parse quality configuration
        id: quality_config
        shell: bash
        run: |
          CONFIG_FILE="${{ inputs.config_path }}"
          
          # Default enabled tools
          DEFAULT_TOOLS='["php-cs-fixer", "psalm", "phpstan", "rector", "phpunit", "composer-validate"]'
          
          if [ -f "$CONFIG_FILE" ]; then
            echo "âœ… Quality configuration file found: $CONFIG_FILE"
            
            # Parse enabled tools from configuration
            if command -v yq >/dev/null 2>&1; then
              # Extract and convert YAML array directly to JSON
              ENABLED_TOOLS=$(yq eval '.quality_checks.enabled_tools | @json' "$CONFIG_FILE" 2>/dev/null)
              if [ "$ENABLED_TOOLS" = "null" ] || [ -z "$ENABLED_TOOLS" ]; then
                ENABLED_TOOLS="$DEFAULT_TOOLS"
              fi
            else
              # Fallback parsing without yq
              ENABLED_TOOLS="$DEFAULT_TOOLS"
            fi
          else
            echo "âš ï¸  Quality configuration file not found: $CONFIG_FILE"
            echo "ðŸ’¡ Using default enabled tools"
            ENABLED_TOOLS="$DEFAULT_TOOLS"
          fi
          
          echo "enabled_tools=$ENABLED_TOOLS" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Enabled quality tools: $ENABLED_TOOLS"
      
      # Run the setup job here, so the cache is generated for the parallel jobs below
      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: '.github/ci-config.yml'
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}  
  
# Basic file validation tasks + PHPUnuhi validation (grouped for efficiency)
  file-validation:
    name: 'ðŸ“‹ Validate Files & Translations'
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: '.github/ci-config.yml'
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}
      
      - name: Run file validation checks
        if: hashFiles('grumphp.yml') != ''
        shell: bash
        run: |
          echo "ðŸ” Running file validation checks..."
          php ./vendor/bin/grumphp run --tasks="git_blacklist,file_size,xmllint,yamllint,composer" || true
      
      - name: Run PHPUnuhi validation
        if: hashFiles('phpunuhi.xml') != ''
        shell: bash
        run: |
          echo "ðŸŒ Running translation validation..."
          php ./vendor/bin/phpunuhi validate:all

      - name: Run custom quality checks
        if: hashFiles(inputs.config_path) != ''
        shell: bash
        run: |
          CONFIG_FILE="${{ inputs.config_path }}"
          
          if [ -f "$CONFIG_FILE" ]; then
            echo "ðŸ”§ Running custom quality checks from: $CONFIG_FILE"
            
            # Parse custom checks from configuration
            if command -v yq >/dev/null 2>&1; then
              CUSTOM_CHECKS=$(yq eval '.quality_checks.custom_checks' "$CONFIG_FILE" 2>/dev/null)
              if [ "$CUSTOM_CHECKS" != "null" ] && [ -n "$CUSTOM_CHECKS" ]; then
                echo "$CUSTOM_CHECKS" | yq eval '.[] | "echo \"Running: " + .name + "\" && " + .command' -
                echo "$CUSTOM_CHECKS" | yq eval '.[] | .command' - | while read -r command; do
                  echo "ðŸ” Executing: $command"
                  eval "$command"
                done
              else
                echo "ðŸ’¡ No custom checks configured"
              fi
            else
              echo "âš ï¸  yq not available, skipping custom checks parsing"
            fi
          else
            echo "ðŸ’¡ No quality configuration file found, skipping custom checks"
          fi
  
  # PHP code quality checks (fast tasks)
  quick-quality-checks:
    name: 'âš¡ Quick Code Quality'
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: '.github/ci-config.yml'
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}
      
      - name: Run Composer Validate
        if: contains(fromJson(needs.setup.outputs.enabled_tools), 'composer-validate')
        shell: bash
        run: |
          echo "ðŸ“¦ Running Composer validation..."
          composer validate --no-check-all --strict

      - name: Get changed files
        if: inputs.check_changed_files_only == true
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            src/**/*.php
            custom/static-plugins/**/*.php
            tests/**/*.php
            **/*.php

      - name: Check PHP-CS-Fixer config exists
        if: contains(fromJson(needs.setup.outputs.enabled_tools), 'php-cs-fixer')
        id: check-php-cs-fixer-config
        shell: bash
        run: |
          if [ -f ".php-cs-fixer.php" ] || [ -f ".php-cs-fixer.dist.php" ]; then
            echo "config_exists=true" >> $GITHUB_OUTPUT
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Run PHP-CS-Fixer on changed files
        if: contains(fromJson(needs.setup.outputs.enabled_tools), 'php-cs-fixer') && steps.check-php-cs-fixer-config.outputs.config_exists == 'true' && (inputs.check_changed_files_only != true || steps.changed-files.outputs.any_changed == 'true')
        shell: bash
        run: |
          echo "ðŸŽ¨ Running PHP-CS-Fixer..."
          if [ "${{ inputs.check_changed_files_only }}" = "true" ] && [ "${{ steps.changed-files.outputs.any_changed }}" = "true" ]; then
            echo "  Checking changed files only: ${{ steps.changed-files.outputs.all_changed_files }}"
            php ./vendor/bin/php-cs-fixer fix --dry-run --diff --stop-on-violation ${{ steps.changed-files.outputs.all_changed_files }}
          else
            echo "  Checking all files"
            php ./vendor/bin/php-cs-fixer fix --dry-run --diff --stop-on-violation
          fi        
  
  # Psalm static analysis (slow task)
  psalm:
    name: 'ðŸ” Psalm Static Analysis'
    needs: setup
    runs-on: ubuntu-latest
    if: contains(fromJson(needs.setup.outputs.enabled_tools), 'psalm')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: '.github/ci-config.yml'
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}
      
      - name: Get changed files
        if: inputs.check_changed_files_only == true
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            src/**/*.php
            custom/static-plugins/**/*.php
            tests/**/*.php
            **/*.php

      - name: Run Psalm on changed files
        if: hashFiles('psalm.xml') != '' && (inputs.check_changed_files_only != true || steps.changed-files.outputs.any_changed == 'true')
        shell: bash
        run: |
          echo "ðŸ” Running Psalm static analysis..."
          if [ "${{ inputs.check_changed_files_only }}" = "true" ] && [ "${{ steps.changed-files.outputs.any_changed }}" = "true" ]; then
            echo "  Analyzing changed files only: ${{ steps.changed-files.outputs.all_changed_files }}"
            php ./vendor/bin/psalm --no-progress --no-cache --config=./psalm.xml ${{ steps.changed-files.outputs.all_changed_files }}
          else
            echo "  Analyzing all files"
            php ./vendor/bin/psalm --no-progress --no-cache --config=./psalm.xml
          fi

  # PHPStan static analysis (new standard)
  phpstan:
    name: 'ðŸ” PHPStan Static Analysis'
    needs: setup
    runs-on: ubuntu-latest
    if: contains(fromJson(needs.setup.outputs.enabled_tools), 'phpstan')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: '.github/ci-config.yml'
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}
      
      - name: Get changed files
        if: inputs.check_changed_files_only == true
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            src/**/*.php
            custom/static-plugins/**/*.php
            tests/**/*.php
            **/*.php

      - name: Run PHPStan on changed files
        if: hashFiles('phpstan.neon') != '' && (inputs.check_changed_files_only != true || steps.changed-files.outputs.any_changed == 'true')
        shell: bash
        run: |
          echo "ðŸ” Running PHPStan static analysis..."
          if [ "${{ inputs.check_changed_files_only }}" = "true" ] && [ "${{ steps.changed-files.outputs.any_changed }}" = "true" ]; then
            echo "  Analyzing changed files only: ${{ steps.changed-files.outputs.all_changed_files }}"
            php ./vendor/bin/phpstan analyse --configuration=phpstan.neon ${{ steps.changed-files.outputs.all_changed_files }}
          else
            echo "  Analyzing all files"
            php ./vendor/bin/phpstan analyse --configuration=phpstan.neon
          fi
          
  # Rector code fixing (slow task)
  rector:
    name: 'ðŸ› ï¸ Rector Code Analysis'
    needs: setup
    runs-on: ubuntu-latest
    if: contains(fromJson(needs.setup.outputs.enabled_tools), 'rector')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: '.github/ci-config.yml'
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}
      
      - name: Get changed files
        if: inputs.check_changed_files_only == true
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            src/**/*.php
            custom/static-plugins/**/*.php
            tests/**/*.php
            **/*.php

      - name: Run Rector on changed files
        if: hashFiles('rector.php') != '' && (inputs.check_changed_files_only != true || steps.changed-files.outputs.any_changed == 'true')
        shell: bash
        run: |
          echo "ðŸ› ï¸ Running Rector code analysis..."
          if [ "${{ inputs.check_changed_files_only }}" = "true" ] && [ "${{ steps.changed-files.outputs.any_changed }}" = "true" ]; then
            echo "  Analyzing changed files only: ${{ steps.changed-files.outputs.all_changed_files }}"
            php ./vendor/bin/rector process --dry-run --no-progress-bar ${{ steps.changed-files.outputs.all_changed_files }}
          else
            echo "  Analyzing all files"
            php ./vendor/bin/rector process --dry-run --no-progress-bar
          fi 
 
  unit-tests:
    name: 'ðŸ§ª PHP Unit Tests'
    needs: setup
    runs-on: ubuntu-latest
    if: contains(fromJson(needs.setup.outputs.enabled_tools), 'phpunit')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: '.github/ci-config.yml'
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}
      
      - name: Run unit tests
        shell: bash
        run: |
          echo "ðŸ§ª Running PHP unit tests..."
          php ./vendor/bin/phpunit --testsuite unit
        env:
          SYMFONY_DEPRECATIONS_HELPER: disabled  
  
  slow-testsuites:
    name: 'ðŸ§ª Slow PHP Unit Test Suites'
    needs: setup
    runs-on: ubuntu-latest
    if: contains(fromJson(needs.setup.outputs.enabled_tools), 'phpunit') && inputs.run_slow_testsuites == true
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: shopware_test
          MYSQL_ROOT_PASSWORD: shopware
          MYSQL_USER: shopware
          MYSQL_PASSWORD: shopware
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672
        options: --health-cmd="rabbitmqctl status" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: '.github/ci-config.yml'
          composer_with_dev: 'yes'
          composer_auth: ${{ secrets.composer_auth }}
      
      - name: Configure test environment
        shell: bash
        run: |
          echo "ðŸ”§ Configuring test environment..."
          echo 'DATABASE_URL=mysql://shopware:shopware@127.0.0.1:3306/shopware_test' >> .env.test.local
          echo 'MESSENGER_TRANSPORT_DSN=amqp://guest:guest@127.0.0.1:5672' >> .env.test.local
          
          # Add additional test environment variables from secret
          if [ -n "${{ secrets.test_env_vars }}" ]; then
            echo "ðŸ” Adding test environment variables from secret..."
            echo "${{ secrets.test_env_vars }}" >> .env.test.local
          else
            echo "ðŸ’¡ No additional test environment variables provided"
          fi
      
      - name: Run integration tests
        shell: bash
        run: |
          echo "ðŸ§ª Running integration tests..."
          php ./vendor/bin/phpunit --testsuite integration
        env:
          SYMFONY_DEPRECATIONS_HELPER: disabled
      
      - name: Run component tests
        shell: bash
        run: |
          echo "ðŸ§ª Running component tests..."
          php ./vendor/bin/phpunit --testsuite component
        env:
          SYMFONY_DEPRECATIONS_HELPER: disabled