name: Deploy

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (test, acc, prod)'
        type: string
        required: true
      config_path:
        description: 'Path to deployment configuration file'
        type: string
        default: '.github/pipeline-config.yml'
      artifact_name:
        description: 'Name of the build artifact to deploy'
        type: string
        required: false
      artifact_run_id:
        description: 'Run ID of the workflow that created the artifact'
        type: string
        required: false
      release_version:
        description: 'Release version to deploy (for manual deployments)'
        type: string
        required: false

    secrets:
      ssh_private_key:
        description: 'SSH private key for deployment'
        required: true

jobs:
  setup:
    name: 'Prepare deployment'
    runs-on: ubuntu-latest
    outputs:
      project_name: ${{ steps.config.outputs.project_name }}
      deploy_date: ${{ steps.setup.outputs.deploy_date }}
      notification_webhook: ${{ steps.config.outputs.notification_webhook }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect project type
        id: detect
        uses: meteor-digital/github-actions/.github/actions/detect-project-type@main

      - name: Read configuration
        id: config
        uses: meteor-digital/github-actions/.github/actions/parse-pipeline-config@main
        with:
          config_file: ${{ inputs.config_path }}
          environment: ${{ inputs.environment }}
          project_type: ${{ steps.detect.outputs.type }}

      - name: Setup deployment variables
        id: setup
        shell: bash
        run: |
          # Format date and set as output
          DEPLOY_DATE=$(date +'%Y%m%d.%H%M')
          echo "deploy_date=$DEPLOY_DATE" >> $GITHUB_OUTPUT

  deploy:
    name: 'Deploy to ${{ inputs.environment }}'
    needs: [setup]
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    # Prevent parallel deployments to the same environment
    concurrency:
      group: deploy-${{ inputs.environment }}
      cancel-in-progress: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Send start notification
        if: ${{ needs.setup.outputs.notification_webhook }}
        uses: meteor-digital/github-actions/.github/actions/notify-teams@main
        with:
          webhook_url: ${{ needs.setup.outputs.notification_webhook }}
          color: "FFFF00"
          message: "üöÄ Deploy **${{ needs.setup.outputs.project_name }}** to **${{ inputs.environment }}**"
        
      - name: Download build artifact from workflow run
        if: inputs.artifact_name && inputs.artifact_run_id
        uses: pyTooling/download-artifact@v5
        with:
          name: ${{ inputs.artifact_name }}
          path: .
          run-id: ${{ inputs.artifact_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download release asset for manual deployment
        if: inputs.release_version
        shell: bash
        run: |
          gh release download ${{ inputs.release_version }} --pattern "*.tar.gz"
          tar -xpf *.tar.gz
          rm *.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            
      - name: Deploy to host
        id: deployment
        uses: meteor-digital/github-actions/.github/actions/deploy-to-host@main
        with:
          config_file: ${{ inputs.config_path }}
          environment: ${{ inputs.environment }}
          build_path: '.'
          ssh_private_key: ${{ secrets.ssh_private_key }}
          
      - name: Send success notification
        if: ${{ success() && needs.setup.outputs.notification_webhook }}
        uses: meteor-digital/github-actions/.github/actions/notify-teams@main
        with:
          webhook_url: ${{ needs.setup.outputs.notification_webhook }}
          color: "00FF00"
          message: |
            ‚úÖ Deploy **${{ needs.setup.outputs.project_name }}** to **${{ inputs.environment }}** SUCCESS
            
            **Environment:** ${{ inputs.environment }}
            **Artifact:** ${{ inputs.artifact_name || inputs.release_version }}
            **Deployed at:** ${{ needs.setup.outputs.deploy_date }}
          
      - name: Send failure notification
        if: ${{ failure() && needs.setup.outputs.notification_webhook }}
        uses: meteor-digital/github-actions/.github/actions/notify-teams@main
        with:
          webhook_url: ${{ needs.setup.outputs.notification_webhook }}
          color: "FF0000"
          message: |
            ‚ùå Deploy **${{ needs.setup.outputs.project_name }}** to **${{ inputs.environment }}** FAILED
            
            **Environment:** ${{ inputs.environment }}
            **Artifact:** ${{ inputs.artifact_name || inputs.release_version }}
            
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})