name: Deploy

on:
  workflow_call:
    inputs:
      config_path:
        description: 'Path to deployment configuration file'
        type: string
        default: '.github/pipeline-config.yml'
      # Automatic parameter determination inputs (primary use case)
      manual_environment:
        description: 'Environment from manual workflow_dispatch'
        type: string
        required: false
      manual_version:
        description: 'Version from manual workflow_dispatch'
        type: string
        required: false
      workflow_run_id:
        description: 'Workflow run ID for automatic deployment'
        type: string
        required: false
      workflow_run_branch:
        description: 'Branch name from workflow_run trigger'
        type: string
        required: false
      workflow_run_conclusion:
        description: 'Conclusion of the workflow_run'
        type: string
        required: false
      event_name:
        description: 'GitHub event name'
        type: string
        required: false

    secrets:
      ssh_private_key:
        description: 'SSH private key for deployment'
        required: true

jobs:
  determine-params:
    name: 'Determine deployment parameters'
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.params.outputs.environment }}
      should_deploy: ${{ steps.params.outputs.should_deploy }}
      artifact_name: ${{ steps.params.outputs.artifact_name }}
      artifact_run_id: ${{ steps.params.outputs.artifact_run_id }}
      release_version: ${{ steps.params.outputs.release_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine artifact name for automatic deployment
        if: inputs.event_name == 'workflow_run'
        id: artifact
        uses: meteor-digital/github-actions/.github/actions/determine-artifact-name@main
        with:
          config_file: ${{ inputs.config_path }}
          ref_name: ${{ inputs.workflow_run_branch }}
          ref_type: 'branch'

      - name: Determine deployment parameters
        id: params
        shell: bash
        run: |
          EVENT_NAME="${{ inputs.event_name }}"
          
          echo "üéØ Determining deployment parameters for event: $EVENT_NAME"
          
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            # Manual deployment
            echo "üîß Manual deployment triggered"
            echo "environment=${{ inputs.manual_environment }}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "artifact_name=" >> $GITHUB_OUTPUT
            echo "artifact_run_id=" >> $GITHUB_OUTPUT
            echo "release_version=${{ inputs.manual_version }}" >> $GITHUB_OUTPUT
            
            echo "  Environment: ${{ inputs.manual_environment }}"
            echo "  Version: ${{ inputs.manual_version || '(latest)' }}"
            
          elif [ "$EVENT_NAME" = "workflow_run" ]; then
            # Automatic deployment from workflow_run
            CONCLUSION="${{ inputs.workflow_run_conclusion }}"
            
            if [ "$CONCLUSION" = "success" ]; then
              echo "üöÄ Automatic deployment from successful workflow_run"
              echo "environment=${{ steps.artifact.outputs.environment }}" >> $GITHUB_OUTPUT
              echo "artifact_name=${{ steps.artifact.outputs.artifact_name }}" >> $GITHUB_OUTPUT
              echo "should_deploy=true" >> $GITHUB_OUTPUT
              echo "artifact_run_id=${{ inputs.workflow_run_id }}" >> $GITHUB_OUTPUT
              echo "release_version=" >> $GITHUB_OUTPUT
              
              echo "  Environment: ${{ steps.artifact.outputs.environment }}"
              echo "  Artifact: ${{ steps.artifact.outputs.artifact_name }}"
              echo "  Run ID: ${{ inputs.workflow_run_id }}"
            else
              echo "‚ùå Workflow run was not successful ($CONCLUSION), skipping deployment"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
            fi
            
          else
            echo "‚ùì Unknown event type, skipping deployment"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi
          
          echo "‚úÖ Deployment parameters determined"

  setup:
    name: 'Prepare deployment'
    runs-on: ubuntu-latest
    needs: [determine-params]
    if: needs.determine-params.outputs.should_deploy == 'true'
    outputs:
      project_name: ${{ steps.config.outputs.project_name }}
      deploy_date: ${{ steps.setup.outputs.deploy_date }}
      notification_webhook: ${{ steps.config.outputs.notification_webhook }}
      final_environment: ${{ needs.determine-params.outputs.environment }}
      final_artifact_name: ${{ needs.determine-params.outputs.artifact_name }}
      final_artifact_run_id: ${{ needs.determine-params.outputs.artifact_run_id }}
      final_release_version: ${{ needs.determine-params.outputs.release_version }}
      final_branch: ${{ inputs.workflow_run_branch || github.ref_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect project type
        id: detect
        uses: meteor-digital/github-actions/.github/actions/detect-project-type@main

      - name: Read configuration
        id: config
        uses: meteor-digital/github-actions/.github/actions/parse-pipeline-config@main
        with:
          config_file: ${{ inputs.config_path }}
          environment: ${{ needs.determine-params.outputs.environment }}
          project_type: ${{ steps.detect.outputs.type }}

      - name: Setup deployment variables
        id: setup
        shell: bash
        run: |
          # Format date and set as output
          DEPLOY_DATE=$(date +'%Y%m%d.%H%M')
          echo "deploy_date=$DEPLOY_DATE" >> $GITHUB_OUTPUT

  deploy:
    name: 'Deploy to ${{ needs.setup.outputs.final_environment }}'
    needs: [determine-params, setup]
    runs-on: ubuntu-latest
    if: needs.determine-params.outputs.should_deploy == 'true'
    environment: ${{ needs.setup.outputs.final_environment }}
    
    # Prevent parallel deployments to the same environment
    concurrency:
      group: deploy-${{ needs.setup.outputs.final_environment }}
      cancel-in-progress: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Send start notification
        if: needs.setup.outputs.notification_webhook
        uses: meteor-digital/github-actions/.github/actions/notify-teams@main
        with:
          webhook_url: ${{ needs.setup.outputs.notification_webhook }}
          branch_name: ${{ needs.setup.outputs.final_branch }}
          color: "FFFF00"
          message: |
            üöÄ Deployment Started
            
            --- 

            **üìã Details:**
            - **Environment:** `${{ needs.setup.outputs.final_environment }}`
            - **${{ needs.setup.outputs.final_artifact_name && 'Artifact' || 'Release' }}:** ${{ needs.setup.outputs.final_artifact_name || needs.setup.outputs.final_release_version }}
        
      - name: Download build artifact from workflow run
        if: needs.setup.outputs.final_artifact_name && needs.setup.outputs.final_artifact_run_id
        uses: pyTooling/download-artifact@v5
        with:
          name: ${{ needs.setup.outputs.final_artifact_name }}
          path: .
          run-id: ${{ needs.setup.outputs.final_artifact_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download release asset for manual deployment
        if: inputs.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          gh release download ${{ needs.setup.outputs.final_release_version }} --pattern "*.tar.gz"
          tar -xpf *.tar.gz
          rm *.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            
      - name: Deploy to host
        id: deployment
        uses: meteor-digital/github-actions/.github/actions/deploy-to-host@main
        with:
          config_file: ${{ inputs.config_path }}
          environment: ${{ needs.setup.outputs.final_environment }}
          build_path: '.'
          ssh_private_key: ${{ secrets.ssh_private_key }}
          
      - name: Send success notification
        if: success() && needs.setup.outputs.notification_webhook
        uses: meteor-digital/github-actions/.github/actions/notify-teams@main
        with:
          webhook_url: ${{ needs.setup.outputs.notification_webhook }}
          branch_name: ${{ needs.setup.outputs.final_branch }}
          color: "00FF00"
          message: |
            ‚úÖ Deployment Successful
            
            ---
            
            **üìã Details:**
            - **Environment:** `${{ needs.setup.outputs.final_environment }}`
            - **${{ needs.setup.outputs.final_artifact_name && 'Artifact' || 'Release' }}:** ${{ needs.setup.outputs.final_artifact_name || needs.setup.outputs.final_release_version }}
            - **Deployed at:** ${{ needs.setup.outputs.deploy_date }}
          
      - name: Send failure notification
        if: failure() && needs.setup.outputs.notification_webhook
        uses: meteor-digital/github-actions/.github/actions/notify-teams@main
        with:
          webhook_url: ${{ needs.setup.outputs.notification_webhook }}
          branch_name: ${{ needs.setup.outputs.final_branch }}
          color: "FF0000"
          message: |
            ‚ùå Deployment Failed
            
            ---
            
            **üìã Details:**
            - **Environment:** `${{ needs.setup.outputs.final_environment }}`
            - **${{ needs.setup.outputs.final_artifact_name && 'Artifact' || 'Release' }}:** ${{ needs.setup.outputs.final_artifact_name || needs.setup.outputs.final_release_version }}