name: Build Artifact

on:
  workflow_call:
    inputs:
      config_path:
        description: 'Path to CI configuration file'
        type: string
        default: '.github/pipeline-config.yml'
      build_type:
        description: 'Build type (development, production)'
        type: string
        default: 'production'
    secrets:
      composer_auth:
        description: 'Composer authentication JSON'
        required: true
      test_env_vars:
        description: 'Additional test environment variables'
        required: false

jobs:
  quality-checks:
    name: 'Quality checks'
    uses: meteor-digital/github-actions/.github/workflows/quality-checks.yml@main
    with:
      config_path: ${{ inputs.config_path }}
      check_changed_files_only: false
      run_slow_testsuites: true
    secrets:
      composer_auth: ${{ secrets.composer_auth }}
      test_env_vars: ${{ secrets.test_env_vars }}

  build:
    name: 'Build artifact'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Read CI configuration
        id: config
        uses: meteor-digital/github-actions/.github/actions/parse-pipeline-config@main
        with:
          config_file: ${{ inputs.config_path }}

      - name: Determine artifact name
        id: determine_artifact_name
        uses: meteor-digital/github-actions/.github/actions/determine-artifact-name@main
        with:
          config_file: ${{ inputs.config_path }}
          ref_name: ${{ github.ref_name }}
          ref_type: ${{ github.ref_type }}
        
      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: ${{ inputs.config_path }}
          composer_with_dev: ${{ inputs.build_type == 'development' && 'yes' || 'no' }}
          composer_auth: ${{ secrets.composer_auth }}
          
      - name: Build project
        uses: meteor-digital/github-actions/.github/actions/build-project@main
        with:
          config_file: ${{ inputs.config_path }}
          
      - name: Upload artifact with permission preservation
        uses: pyTooling/upload-artifact@v4
        with:
          name: ${{ steps.determine_artifact_name.outputs.artifact_name }}
          path: .
          include-hidden-files: true
          retention-days: ${{ steps.config.outputs.retention_days || 7 }}
          
      - name: Create build archive for release
        if: github.ref_type == 'tag'
        shell: bash
        run: |
          # Create release tar.gz from cleaned workspace (preserves Unix permissions)
          tar --warning=no-file-changed -czpf build-${{ github.ref_name }}.tar.gz .
          
      - name: Create GitHub release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          files: build-${{ github.ref_name }}.tar.gz
          tag_name: ${{ github.ref_name }}
          name: ${{ steps.config.outputs.project_name }} Release ${{ github.ref_name }}
          body: |
            üöÄ Production Release ${{ github.ref_name }}

            ---
            
            **Build Information:**
            - Project: ${{ steps.config.outputs.project_name }}
            - Commit: ${{ github.sha }}
            - Build Date: ${{ github.event.head_commit.timestamp }}
            - Workflow: ${{ github.workflow }} #${{ github.run_number }}
            
            **Artifact:** ${{ steps.determine_artifact_name.outputs.artifact_name }}
          draft: false
          prerelease: false
          
      - name: Send success notification
        if: success() && steps.config.outputs.notification_webhook
        uses: meteor-digital/github-actions/.github/actions/notify-teams@main
        with:
          webhook_url: ${{ steps.config.outputs.notification_webhook }}
          color: "00FF00"
          message: |
            ‚úÖ Build Artifact Created
            
            ---
            
            **üìã Details:**
            - **Artifact:** `${{ steps.determine_artifact_name.outputs.artifact_name }}`
            - **Branch/Tag:** ${{ github.ref_name }}
            - **Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          
      - name: Send failure notification
        if: failure() && steps.config.outputs.notification_webhook
        uses: meteor-digital/github-actions/.github/actions/notify-teams@main
        with:
          webhook_url: ${{ steps.config.outputs.notification_webhook }}
          color: "FF0000"
          message: |
            ‚ùå Build Failed
            
            ---
            
            **üìã Details:**
            - **Branch/Tag:** ${{ github.ref_name }}
            - **Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})