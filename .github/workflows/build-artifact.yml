name: Build Artifact

on:
  workflow_call:
    inputs:
      config_path:
        description: 'Path to CI configuration file'
        type: string
        default: '.github/pipeline-config.yml'
      build_type:
        description: 'Build type (development, production)'
        type: string
        default: 'production'
    secrets:
      composer_auth:
        description: 'Composer authentication JSON'
        required: true
      test_env_vars:
        description: 'Additional test environment variables'
        required: false

jobs:
  quality-checks:
    name: 'Quality checks'
    uses: meteor-digital/github-actions/.github/workflows/quality-checks.yml@main
    with:
      config_path: ${{ inputs.config_path }}
      check_changed_files_only: false
      run_slow_testsuites: true
    secrets:
      composer_auth: ${{ secrets.composer_auth }}
      test_env_vars: ${{ secrets.test_env_vars }}

  build:
    name: 'Build artifact'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Read CI configuration
        id: config
        uses: meteor-digital/github-actions/.github/actions/parse-pipeline-config@main
        with:
          config_file: ${{ inputs.config_path }}

      - name: Detect project type
        id: detect_type
        uses: meteor-digital/github-actions/.github/actions/detect-project-type@main
        with:
          config_file: ${{ inputs.config_path }}

      - name: Determine artifact name
        id: determine_artifact_name
        uses: meteor-digital/github-actions/.github/actions/determine-artifact-name@main
        with:
          config_file: ${{ inputs.config_path }}
          ref_name: ${{ github.ref_name }}
          ref_type: ${{ github.ref_type }}
        
      - name: Setup environment
        uses: meteor-digital/github-actions/.github/actions/setup-environment@main
        with:
          config_file: ${{ inputs.config_path }}
          composer_with_dev: ${{ inputs.build_type == 'development' && 'yes' || 'no' }}
          composer_auth: ${{ secrets.composer_auth }}
          # Force Node.js setup for Shopware admin builds (even without package.json)
          node_skip_setup: ${{ steps.detect_type.outputs.type == 'shopware' && 'false' || 'true' }}
          skip_composer_cache: 'yes'
          
      - name: Build project
        uses: meteor-digital/github-actions/.github/actions/build-project@main
        with:
          config_file: ${{ inputs.config_path }}
          
      - name: Upload artifact with permission preservation
        if: github.ref_type == 'branch'
        uses: pyTooling/upload-artifact@v4
        with:
          name: ${{ steps.determine_artifact_name.outputs.artifact_name }}
          path: .
          include-hidden-files: true
          retention-days: ${{ steps.config.outputs.retention_days || 7 }}
          
      - name: Create build archive for release
        if: github.ref_type == 'tag'
        shell: bash
        run: |
          # Create release tar.gz from cleaned workspace (preserves Unix permissions)
          TAR_PATH="$RUNNER_TEMP/build-${{ github.ref_name }}.tar.gz"
          tar -czf "$TAR_PATH" --exclude='.git' --exclude='.github' --exclude='var' --exclude='.env.local' .
          mv "$TAR_PATH" .
          
      - name: Generate build timestamp
        if: github.ref_type == 'tag'
        id: build_time
        shell: bash
        run: echo "timestamp=$(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_OUTPUT
        
      - name: Create GitHub release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          files: build-${{ github.ref_name }}.tar.gz
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          body: |
            ## üì¶ Build Information
            
            | Property | Value |
            |----------|-------|
            | **Build Date** | ${{ steps.build_time.outputs.timestamp }} |
            | **Commit** | [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |
            | **Workflow Run** | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          draft: false
          prerelease: false
          
      - name: Send success notification
        if: success() && steps.config.outputs.notification_webhook
        uses: meteor-digital/github-actions/.github/actions/notify-teams@main
        with:
          webhook_url: ${{ steps.config.outputs.notification_webhook }}
          color: "00FF00"
          message: |
            ‚úÖ ${{ github.ref_type == 'tag' && 'Release' || 'Build Artifact' }} Created
            
            ---
            
            **üìã Details:**
            - **${{ github.ref_type == 'tag' && 'Release' || 'Artifact' }}:** ${{ github.ref_type == 'tag' && format('[{0}]({1}/{2}/releases/tag/{0})', github.ref_name, github.server_url, github.repository) || format('`{0}`', steps.determine_artifact_name.outputs.artifact_name) }}
            - **Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          
      - name: Send failure notification
        if: failure() && steps.config.outputs.notification_webhook
        uses: meteor-digital/github-actions/.github/actions/notify-teams@main
        with:
          webhook_url: ${{ steps.config.outputs.notification_webhook }}
          color: "FF0000"
          message: |
            ‚ùå ${{ github.ref_type == 'tag' && 'Creating Release' || 'Building Artifact' }} Failed
            
            ---
            
            **üìã Details:**
            - **${{ github.ref_type == 'tag' && 'Release' || 'Artifact' }}:** `${{ github.ref_type == 'tag' && github.ref_name || steps.determine_artifact_name.outputs.artifact_name }}`
            - **Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})